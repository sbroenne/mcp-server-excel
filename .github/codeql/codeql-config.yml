# CodeQL Configuration for ExcelMcp
# Defines security scanning rules and exclusions  
# Version: 3.0 - Comprehensive COM interop pattern suppressions
#
# Summary of Intentional Exclusions:
# - cs/catch-of-all-exceptions: COM requires broad exception handling
# - cs/empty-catch-block: Cleanup must not fail operations
# - cs/call-to-gc: Required for COM resource management
# - cs/nested-if-statements: Complex validation requires nested conditions
# - cs/dereferenced-value-may-be-null: Custom validation patterns
# - cs/useless-upcast: COM dynamic types require explicit casts
# - cs/invalid-dynamic-call: COM interop uses dynamic extensively
#
# See CODEQL-FIXES-SUMMARY.md for detailed rationale

name: "ExcelMcp CodeQL Configuration v3.0"

# Disable default query suite and use custom ones
disable-default-queries: false

# Query packs to run
queries:
  # Built-in security queries
  - uses: security-and-quality
  - uses: security-extended

# Paths to exclude from analysis
paths-ignore:
  - '**/bin/**'
  - '**/obj/**'
  - '**/packages/**'
  - '**/.nuget/**'
  - '**/node_modules/**'
  - '**/*.Designer.cs'
  - '**/*.g.cs'
  - '**/*.g.i.cs'
  - '**/AssemblyInfo.cs'
  - '**/TemporaryGeneratedFile_*.cs'

# Paths to explicitly include
paths:
  - 'src/**'
  - 'tests/**'

# Query filters
query-filters:
  # Exclude specific queries that may be false positives
  # Uncomment and adjust as needed

  # COM interop may trigger weak crypto warnings for Excel automation
  - exclude:
      id: cs/weak-crypto
      reason: "Excel COM interop uses Windows crypto APIs"

  # Dynamic typing is required for COM interop
  - exclude:
      id: cs/call-to-unmanaged-code
      reason: "Required for Excel COM interop automation"

  # External libraries may use reflection
  - exclude:
      id: cs/reflection
      reason: "External libraries may use reflection"

  # GC.Collect is required for COM interop cleanup
  - exclude:
      id: cs/call-to-gc
      reason: "Explicit GC.Collect() required for COM object cleanup in Excel automation. See COM cleanup pattern in ExcelBatch/ExcelSession."
      paths:
        - 'src/ExcelMcp.ComInterop/Session/**'
        - 'tests/**/Session/**'

  # Test-specific exclusions (note-severity only)
  # Tests often use patterns that are acceptable in test context

  # COM interop requires catching all exceptions for proper cleanup and fallback patterns
  # Excel COM can throw COMException, InvalidCastException, or generic Exception
  # We re-throw with context or handle fallback scenarios (e.g., version compatibility)
  - exclude:
      id: cs/catch-of-all-exceptions
      reason: "COM interop requires catching all exceptions. Three patterns: 1) Re-throw with context for better error messages, 2) Cleanup handlers that suppress errors during resource release, 3) Fallback patterns for Excel version compatibility. All exceptions are logged or re-thrown with additional context."
      paths:
        - 'src/ExcelMcp.Core/Commands/**'
        - 'src/ExcelMcp.ComInterop/**'
        - 'src/ExcelMcp.CLI/Commands/**'
        - 'src/ExcelMcp.McpServer/Tools/**'
        - 'tests/**/Helpers/**'
        - 'tests/**/Fixtures/**'

  # Empty catch blocks in COM cleanup code - intentionally ignore failures during resource release
  - exclude:
      id: cs/empty-catch-block
      reason: "COM cleanup code intentionally ignores failures during Marshal.ReleaseComObject and Dispose. Preventing exceptions during cleanup is critical for Excel automation. Cleanup must never fail the operation."
      paths:
        - 'src/ExcelMcp.ComInterop/**'
        - 'src/ExcelMcp.Core/Commands/**'
        - 'src/ExcelMcp.CLI/Commands/**'
        - 'src/ExcelMcp.McpServer/Tools/**'
        - 'tests/**'

  # Empty blocks and useless if statements - sometimes used for future expansion or clarity
  - exclude:
      id: cs/empty-block
      reason: "Empty blocks may be intentional placeholders or result from refactoring. These are cleaned up periodically."
      paths:
        - 'tests/**'

  - exclude:
      id: cs/useless-if-statement
      reason: "Conditional statements may be preserved for clarity or future expansion during development."
      paths:
        - 'tests/**'

  # Path.Combine has been replaced with Path.Join across the codebase
  # No exclusions needed - all instances fixed

  # LINQ suggestions in tests are optional
  - exclude:
      id: cs/linq/missed-where
      reason: "Test code readability over performance"
      paths:
        - 'tests/**'

  # Code quality suggestions that are acceptable in COM interop context
  # Nested if statements often required for: null checks, type validation, version compatibility
  - exclude:
      id: cs/nested-if-statements
      reason: "COM interop requires careful null checking, type validation, and version compatibility checks with nested conditions. Combining conditions would reduce clarity and error message quality."
      paths:
        - 'src/**'
        - 'tests/**'

  - exclude:
      id: cs/invalid-dynamic-call
      reason: "Dynamic calls required for Excel COM interop - CodeQL cannot validate COM object signatures"
      paths:
        - 'src/**'

  - exclude:
      id: cs/missed-ternary-operator
      reason: "Explicit if/else preferred for clarity in COM interop code"
      paths:
        - 'src/**'

  # Nullable parameter dereferencing after validation
  # CodeQL doesn't recognize ThrowMissingParameter/HasValue checks as null-safety patterns
  - exclude:
      id: cs/dereferenced-value-may-be-null
      reason: "Parameters validated through ThrowMissingParameter() or HasValue checks before use. CodeQL doesn't recognize these as null-safety patterns. COM objects validated through try/catch patterns rather than null checks."
      paths:
        - 'src/**'
        - 'tests/**'

  # Explicit casts for COM interop - dynamic types require explicit conversions
  - exclude:
      id: cs/useless-upcast
      reason: "Explicit casts required for COM interop type resolution. COM returns dynamic objects that need explicit type conversion even when the cast appears redundant to CodeQL."
      paths:
        - 'src/**'
        - 'tests/**'

  # LINQ Select suggestions - explicit loops often clearer for complex transformations
  - exclude:
      id: cs/linq/missed-select
      reason: "Explicit loops preferred for clarity in test code, COM iteration, and complex transformations where intermediate variables improve readability."
      paths:
        - 'src/**'
        - 'tests/**'

  # Explicit boolean expressions for clarity
  - exclude:
      id: cs/simplifiable-boolean-expression
      reason: "Explicit boolean expressions preferred for clarity in COM validation logic and error handling."
      paths:
        - 'src/**'
        - 'tests/**'

  # Unmanaged code required for OLE message filter and COM interop
  - exclude:
      id: cs/unmanaged-code
      reason: "COM interop requires unmanaged code calls to Excel automation interfaces and OLE message filter for proper COM communication."
      paths:
        - 'src/ExcelMcp.ComInterop/**'

  - exclude:
      id: cs/useless-tostring-call
      reason: "Explicit ToString() sometimes needed for COM object string conversion"

  # Ternary operator suggestions in tests
  - exclude:
      id: cs/missed-ternary-operator
      reason: "Test code clarity over brevity"
      paths:
        - 'tests/**'

  # Useless assignments are legitimate in test setup and COM interop for clarity/debugging
  # Local variables may be assigned for intermediate values during COM operations
  - exclude:
      id: cs/useless-assignment-to-local
      reason: "Test setup and COM interop may assign variables for clarity, debugging, or intermediate COM object references even if not directly used in final operation."
      paths:
        - 'src/**'
        - 'tests/**'

  # ConfigureAwait suggestions - library code without SynchronizationContext
  - exclude:
      id: cs/async-missing-await
      reason: "Library code without UI context - ConfigureAwait(false) not required"

  - exclude:
      id: cs/missing-await-using
      reason: "Library code without UI context - ConfigureAwait(false) not required"

  # String concatenation and interpolation in non-SQL contexts
  - exclude:
      id: cs/string-concatenation-in-loop
      reason: "String interpolation and concatenation used for messages and non-SQL contexts"

  # Null-coalescing and conditional access patterns
  - exclude:
      id: cs/constant-condition
      reason: "Null-coalescing operators and null checks used appropriately for COM interop defaults"

  # Type casting for COM interop
  - exclude:
      id: cs/useless-cast-to-self
      reason: "Explicit casts sometimes required for COM type resolution"

  # Culture-invariant string operations
  - exclude:
      id: cs/locale-dependent-compare
      reason: "ToLower/ToUpper used for internal case-insensitive comparisons, not user-facing data"

  # Lambda and delegate suggestions
  - exclude:
      id: cs/lambda-unused-parameter
      reason: "Lambda expressions may have unused parameters for interface compliance"

  # Cyclomatic complexity in COM interop
  - exclude:
      id: cs/complex-condition
      reason: "Complex conditions necessary for COM type validation and error handling"

  # Resource cleanup patterns
  - exclude:
      id: cs/dispose-not-called
      reason: "COM objects released through Marshal.FinalReleaseComObject in finally blocks"

  # Async patterns in library code
  - exclude:
      id: cs/async-void-method
      reason: "Event handlers and test methods may use async void appropriately"
      paths:
        - 'tests/**'

  # Variable naming conventions
  - exclude:
      id: cs/local-not-read
      reason: "Local variables may be assigned for debugging or future use"

  # Magic number suggestions
  - exclude:
      id: cs/magic-number
      reason: "Hardcoded numbers are clear and intentional in context (Excel row/column indices, timeouts)"

  # Collection initialization
  - exclude:
      id: cs/array-init-length
      reason: "Explicit collection initialization preferred for clarity in test data"
      paths:
        - 'tests/**'

  # Switch expression suggestions
  - exclude:
      id: cs/switch-expr-not-exhaustive
      reason: "Traditional switch statements preferred for clarity in COM interop code"

  # Readonly field suggestions
  - exclude:
      id: cs/unused-field
      reason: "Fields may need to remain for dependency injection or test mocking"

  # Parameter validation
  - exclude:
      id: cs/unchecked-conversion
      reason: "Parameter validation occurs in public method before async implementation method"

  # Additional common quality suggestions
  - exclude:
      id: cs/long-method
      reason: "COM interop methods may be long due to cleanup and error handling requirements"

  - exclude:
      id: cs/too-many-parameters
      reason: "Excel COM methods may require many parameters for comprehensive configuration"

  - exclude:
      id: cs/duplicate-code
      reason: "COM cleanup patterns intentionally duplicated for reliability"

  - exclude:
      id: cs/local-shadow
      reason: "Local variable shadowing acceptable when scope is clear"

# External data sources (for taint tracking)
# external-repository-token: ${{ secrets.GITHUB_TOKEN }}

# ML-powered alerts (experimental)
ml-powered-queries: true

# Trap caching for faster subsequent runs
trap-caching: true

# Build mode for compiled languages
# build-mode: 'manual' for custom build commands

# Additional configuration
packs:
  csharp:
    - codeql/csharp-queries
    - codeql/csharp-all

# Security policy
security-policy:
  # Severity levels to report
  minimum-severity: medium

  # Report on security findings
  fail-on-severity: high

  # License compliance
  check-licenses: true
