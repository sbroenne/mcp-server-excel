name: Release VS Code Extension

# This workflow builds and releases the ExcelMcp VS Code extension
# Triggered by pushing tags matching 'vscode-v*'

on:
  push:
    tags:
      - 'vscode-v*'

jobs:
  release-vscode-extension:
    runs-on: windows-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write

    steps:
    - uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 8.0.x

    - name: Update MCP Server Version
      run: |
        $tagName = "${{ github.ref_name }}"
        $version = $tagName -replace '^vscode-v', ''

        Write-Output "Updating MCP Server to version $version for bundled executable"

        # Update MCP Server project version
        $mcpCsprojPath = "src/ExcelMcp.McpServer/ExcelMcp.McpServer.csproj"
        $mcpContent = Get-Content $mcpCsprojPath -Raw
        $mcpContent = $mcpContent -replace '<Version>[\d\.]+</Version>', "<Version>$version</Version>"
        $mcpContent = $mcpContent -replace '<AssemblyVersion>[\d\.]+\.[\d\.]+</AssemblyVersion>', "<AssemblyVersion>$version.0</AssemblyVersion>"
        $mcpContent = $mcpContent -replace '<FileVersion>[\d\.]+\.[\d\.]+</FileVersion>', "<FileVersion>$version.0</FileVersion>"
        Set-Content $mcpCsprojPath $mcpContent

        Write-Output "Updated MCP Server project to version $version"
      shell: pwsh

    - name: Build Bundled MCP Server
      run: |
        Write-Output "Building framework-dependent MCP Server executable"
        
        # Ensure bin directory exists
        New-Item -ItemType Directory -Path "vscode-extension/bin" -Force
        
        # Publish framework-dependent executable (works on both x64 and ARM64 with .NET runtime)
        dotnet publish src/ExcelMcp.McpServer/ExcelMcp.McpServer.csproj `
          -c Release `
          -o "vscode-extension/bin" `
          --verbosity minimal

        # Verify the executable was created
        $exePath = "vscode-extension/bin/Sbroenne.ExcelMcp.McpServer.exe"
        if (Test-Path $exePath) {
          $fileInfo = Get-Item $exePath
          Write-Output "‚úÖ Created framework-dependent executable: $($fileInfo.Name) ($([math]::Round($fileInfo.Length / 1MB, 2)) MB)"
        } else {
          Write-Error "‚ùå Failed to create executable at $exePath"
          exit 1
        }
        
        Write-Output "‚úÖ Built framework-dependent executable (works on x64 and ARM64 with .NET runtime)"
      shell: pwsh

    - name: Update Extension Version
      run: |
        $tagName = "${{ github.ref_name }}"
        $version = $tagName -replace '^vscode-v', ''

        Write-Output "Updating VS Code extension to version $version"

        # Update package.json version
        cd vscode-extension
        npm version "$version" --no-git-tag-version

        # Update CHANGELOG.md - replace the first version number and date
        $date = Get-Date -Format 'yyyy-MM-dd'
        $changelogPath = 'CHANGELOG.md'
        $changelogContent = Get-Content $changelogPath -Raw
        $changelogContent = $changelogContent -replace '(?m)^## \[\d+\.\d+\.\d+\] - \d{4}-\d{2}-\d{2}', "## [$version] - $date"
        Set-Content $changelogPath $changelogContent

        Write-Output "Updated extension version to $version"
        Write-Output "Updated CHANGELOG.md to version $version with date $date"
        "PACKAGE_VERSION=$version" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
      shell: pwsh

    - name: Install Dependencies
      run: |
        cd vscode-extension
        npm install

    - name: Compile TypeScript
      run: |
        cd vscode-extension
        npm run compile

    - name: Lint Extension
      run: |
        cd vscode-extension
        npm run lint || true

    - name: Package Extension
      run: |
        cd vscode-extension
        npx @vscode/vsce package --no-dependencies --allow-missing-repository

        $version = "${{ env.PACKAGE_VERSION }}"
        $vsixFile = "excelmcp-$version.vsix"

        # Rename if needed
        $existingVsix = Get-ChildItem -Path . -Filter "excelmcp-*.vsix" -File | Select-Object -First 1
        if ($existingVsix -and $existingVsix.Name -ne $vsixFile) {
          Rename-Item $existingVsix.FullName -NewName $vsixFile
        }

        Write-Output "Created $vsixFile"
        Get-Item $vsixFile | Format-Table Name, Length
        "VSIX_PATH=vscode-extension/$vsixFile" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
      shell: pwsh

    - name: Publish to VS Code Marketplace
      uses: HaaLeo/publish-vscode-extension@v2
      with:
        pat: ${{ secrets.VSCE_TOKEN }}
        registryUrl: https://marketplace.visualstudio.com
        extensionFile: ${{ env.VSIX_PATH }}
      continue-on-error: true
      id: publishToMarketplace

    - name: Create GitHub Release
      run: |
        $tagName = "${{ github.ref_name }}"
        $version = "${{ env.PACKAGE_VERSION }}"
        $vsixFile = "${{ env.VSIX_PATH }}"

        # Check marketplace publishing results
        $marketplaceStatus = "‚ùå Not published"

        if ("${{ steps.publishToMarketplace.outcome }}" -eq "success") {
          $marketplaceStatus = "‚úÖ Published to VS Code Marketplace"
        }

        # Create release notes
        $releaseNotes = @"
## ExcelMcp VS Code Extension $tagName

### One-Click Excel MCP Server Installation for VS Code

This extension automatically registers the ExcelMcp MCP server with VS Code, enabling AI assistants like GitHub Copilot to control Microsoft Excel through 10 specialized tools.

### Installation Options

**Option 1: VS Code Marketplace (Recommended)**
- Search for "ExcelMcp" in VS Code Extensions
- Click Install
- Extension auto-installs .NET 8 runtime and includes bundled MCP server

**Option 2: Manual VSIX Install**
- Download ``excelmcp-$version.vsix`` below
- In VS Code: ``Ctrl+Shift+P`` ‚Üí "Install from VSIX"
- Select the downloaded VSIX file

### Publishing Status

- $marketplaceStatus

### Key Features
- ‚úÖ **Zero Configuration** - Automatic MCP server registration
- ‚úÖ **Automatic .NET Installation** - Uses .NET Install Tool extension  
- ‚úÖ **Bundled MCP Server** - No separate tool installation required
- ‚úÖ **Works Everywhere** - All VS Code workspaces, no per-workspace config
- ‚úÖ **10 Excel Tools** - 108+ actions for Excel automation

### Excel Tools Available (108+ actions)

1. **excel_powerquery** (11 actions) - Power Query M code management
2. **excel_datamodel** (20 actions) - DAX measures & Data Model
3. **table** (22 actions) - Excel Tables/ListObjects
4. **excel_range** (30+ actions) - Range operations
5. **excel_vba** (7 actions) - VBA macros
6. **excel_connection** (11 actions) - Data connections
7. **excel_worksheet** (5 actions) - Worksheet lifecycle
8. **excel_parameter** (6 actions) - Named ranges
9. **excel_file** (1 action) - File creation
10. **excel_version** (1 action) - Update checking

### Requirements

- **Windows OS** - Excel COM automation requires Windows
- **Microsoft Excel 2016+** - Must be installed on your system
- **.NET 8 Runtime** - **Automatically installed** by the extension
- **VS Code 1.105.0+** - For MCP support

### Benefits vs Manual Configuration

Before (Manual):
- ‚ùå Install .NET 8 SDK manually
- ‚ùå Run ``dotnet tool install`` command
- ‚ùå Create ``.vscode/mcp.json`` manually
- ‚ùå Error-prone JSON editing
- ‚ùå Per-workspace setup

After (Extension):
- ‚úÖ One-click install from Marketplace
- ‚úÖ .NET runtime auto-installed
- ‚úÖ MCP server bundled with extension
- ‚úÖ Works in all workspaces
- ‚úÖ Welcome message guides users

### Documentation

- [Installation Guide](https://github.com/sbroenne/mcp-server-excel/blob/main/vscode-extension/INSTALL.md)
- [Developer Guide](https://github.com/sbroenne/mcp-server-excel/blob/main/vscode-extension/DEVELOPMENT.md)
- [Main Repository](https://github.com/sbroenne/mcp-server-excel)

### Package Details

- **Size**: ~28 MB (includes framework-dependent MCP server executable)
- **Files**: Extension code + .NET framework-dependent MCP server
- **Dependencies**: ms-dotnettools.vscode-dotnet-runtime (auto-installs .NET 8)
- **License**: MIT
"@

        Set-Content -Path "release_notes.md" -Value $releaseNotes

        # Create the release
        gh release create "$tagName" `
          "$vsixFile" `
          --title "ExcelMcp VS Code Extension $tagName" `
          --notes-file release_notes.md

        Write-Output "‚úÖ Released ExcelMcp VS Code Extension $version"
        Write-Output "üì¶ Package: excelmcp-$version.vsix"
        Write-Output "üîó Release: https://github.com/sbroenne/mcp-server-excel/releases/tag/$tagName"
        Write-Output "üìä Marketplace: $marketplaceStatus"
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      shell: pwsh
