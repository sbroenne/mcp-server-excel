name: Housekeeping - Cleanup Old Releases

on:
  schedule:
    # Run every Sunday at 2 AM UTC
    - cron: '0 2 * * 0'
  workflow_dispatch:  # Allow manual triggering

permissions:
  contents: write  # Required to delete tags and releases
  
jobs:
  cleanup-releases:
    name: Cleanup Old Tags and Releases
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for all tags
      
      - name: Setup GitHub CLI
        run: |
          type -p gh >/dev/null || (echo "GitHub CLI already installed" && gh --version)
      
      - name: Cleanup old releases and tags
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          echo "üßπ Starting housekeeping - cleanup old tags and releases"
          echo "========================================================"
          echo ""
          
          KEEP_COUNT=3
          DELETED_RELEASES=0
          DELETED_TAGS=0
          FAILED_RELEASES=0
          FAILED_TAGS=0
          
          # Function to get releases from GitHub API
          get_github_releases() {
            local pattern=$1
            gh api repos/${{ github.repository }}/releases \
              --paginate \
              --jq "[.[] | select(.tag_name | test(\"^${pattern}\")) | {tag: .tag_name, created: .created_at, id: .id}] | sort_by(.created) | reverse"
          }
          
          # Function to get tags from GitHub API
          get_github_tags() {
            local pattern=$1
            gh api repos/${{ github.repository }}/tags \
              --paginate \
              --jq "[.[] | select(.name | test(\"^${pattern}\")) | {tag: .name, commit: .commit.sha}]"
          }
          
          # Function to delete release with error handling
          delete_release() {
            local tag=$1
            local release_id=$2
            echo "  üóëÔ∏è  Deleting release: $tag (ID: $release_id)"
            local output
            output=$(gh api -X DELETE repos/${{ github.repository }}/releases/$release_id 2>&1)
            local exit_code=$?
            if [ $exit_code -eq 0 ]; then
              echo "  ‚úÖ  Successfully deleted release: $tag"
              return 0
            else
              echo "  ‚ùå  Failed to delete release: $tag"
              echo "     Error: $output"
              return 1
            fi
          }
          
          # Function to delete tag with error handling
          delete_tag() {
            local tag=$1
            echo "  üóëÔ∏è  Deleting tag: $tag"
            local output
            output=$(gh api -X DELETE repos/${{ github.repository }}/git/refs/tags/$tag 2>&1)
            local exit_code=$?
            if [ $exit_code -eq 0 ]; then
              echo "  ‚úÖ  Successfully deleted tag: $tag"
              return 0
            else
              echo "  ‚ùå  Failed to delete tag: $tag"
              echo "     Error: $output"
              return 1
            fi
          }
          
          # Process VSCode Extension releases and tags
          echo "üì¶ Processing VS Code Extension (vscode-v*)"
          echo "--------------------------------------------"
          
          vscode_releases=$(get_github_releases "vscode-v")
          vscode_count=$(echo "$vscode_releases" | jq 'length')
          
          if [ "$vscode_count" -gt 0 ]; then
            echo "  Found $vscode_count releases"
            
            # Get releases to keep and delete
            keep_releases=$(echo "$vscode_releases" | jq -r ".[0:$KEEP_COUNT] | .[] | .tag")
            delete_releases=$(echo "$vscode_releases" | jq -r ".[$KEEP_COUNT:] | .[] | {tag: .tag, id: .id} | @json")
            
            echo "  ‚úÖ Keeping $(echo "$keep_releases" | wc -l) most recent:"
            echo "$keep_releases" | sed 's/^/     - /'
            
            delete_count=$(echo "$delete_releases" | grep -c "^{" || echo "0")
            if [ "$delete_count" -gt 0 ]; then
              echo "  ‚ùå Deleting $delete_count old releases:"
              
              while IFS= read -r release_json; do
                if [ -n "$release_json" ]; then
                  tag=$(echo "$release_json" | jq -r '.tag')
                  id=$(echo "$release_json" | jq -r '.id')
                  echo "     - $tag"
                  if delete_release "$tag" "$id"; then
                    DELETED_RELEASES=$((DELETED_RELEASES + 1))
                  else
                    FAILED_RELEASES=$((FAILED_RELEASES + 1))
                  fi
                  if delete_tag "$tag"; then
                    DELETED_TAGS=$((DELETED_TAGS + 1))
                  else
                    FAILED_TAGS=$((FAILED_TAGS + 1))
                  fi
                fi
              done <<< "$delete_releases"
            else
              echo "  ‚úÖ No old releases to delete"
            fi
          else
            echo "  ‚ÑπÔ∏è  No vscode-v* releases found"
          fi
          
          echo ""
          
          # Process MCP Server & CLI releases and tags (excluding vscode-v*)
          echo "üì¶ Processing MCP Server & CLI (v* excluding vscode-v*)"
          echo "--------------------------------------------------------"
          
          # Get all v* releases
          all_v_releases=$(get_github_releases "v")
          # Filter out vscode-v* releases
          mcp_releases=$(echo "$all_v_releases" | jq '[.[] | select(.tag | test("^vscode-v") | not)]')
          mcp_count=$(echo "$mcp_releases" | jq 'length')
          
          if [ "$mcp_count" -gt 0 ]; then
            echo "  Found $mcp_count releases"
            
            # Get releases to keep and delete
            keep_releases=$(echo "$mcp_releases" | jq -r ".[0:$KEEP_COUNT] | .[] | .tag")
            delete_releases=$(echo "$mcp_releases" | jq -r ".[$KEEP_COUNT:] | .[] | {tag: .tag, id: .id} | @json")
            
            echo "  ‚úÖ Keeping $(echo "$keep_releases" | wc -l) most recent:"
            echo "$keep_releases" | sed 's/^/     - /'
            
            delete_count=$(echo "$delete_releases" | grep -c "^{" || echo "0")
            if [ "$delete_count" -gt 0 ]; then
              echo "  ‚ùå Deleting $delete_count old releases:"
              
              while IFS= read -r release_json; do
                if [ -n "$release_json" ]; then
                  tag=$(echo "$release_json" | jq -r '.tag')
                  id=$(echo "$release_json" | jq -r '.id')
                  echo "     - $tag"
                  if delete_release "$tag" "$id"; then
                    DELETED_RELEASES=$((DELETED_RELEASES + 1))
                  else
                    FAILED_RELEASES=$((FAILED_RELEASES + 1))
                  fi
                  if delete_tag "$tag"; then
                    DELETED_TAGS=$((DELETED_TAGS + 1))
                  else
                    FAILED_TAGS=$((FAILED_TAGS + 1))
                  fi
                fi
              done <<< "$delete_releases"
            else
              echo "  ‚úÖ No old releases to delete"
            fi
          else
            echo "  ‚ÑπÔ∏è  No v* releases found (excluding vscode-v*)"
          fi
          
          echo ""
          
          # Cleanup orphaned tags (tags without releases)
          echo "üè∑Ô∏è  Checking for orphaned tags (tags without releases)"
          echo "-------------------------------------------------------"
          
          # Get all tags from GitHub
          all_tags=$(gh api repos/${{ github.repository }}/tags --paginate --jq '.[].name')
          
          # Get all release tags
          all_release_tags=$(gh api repos/${{ github.repository }}/releases --paginate --jq '.[].tag_name')
          
          # Find orphaned tags
          orphaned_tags=$(comm -23 <(echo "$all_tags" | sort) <(echo "$all_release_tags" | sort))
          orphaned_count=$(echo "$orphaned_tags" | grep -v '^$' | wc -l)
          
          if [ "$orphaned_count" -gt 0 ]; then
            echo "  Found $orphaned_count orphaned tags"
            
            # Process vscode-v* orphaned tags
            vscode_orphaned=$(echo "$orphaned_tags" | grep "^vscode-v" || echo "")
            if [ -n "$vscode_orphaned" ]; then
              vscode_orphaned_array=($(echo "$vscode_orphaned"))
              vscode_orphaned_count=${#vscode_orphaned_array[@]}
              
              if [ "$vscode_orphaned_count" -gt "$KEEP_COUNT" ]; then
                echo "  ‚ùå Deleting $((vscode_orphaned_count - KEEP_COUNT)) old vscode-v* orphaned tags"
                # Keep the last N, delete the rest
                for ((i=KEEP_COUNT; i<vscode_orphaned_count; i++)); do
                  tag="${vscode_orphaned_array[$i]}"
                  echo "     - $tag"
                  if delete_tag "$tag"; then
                    DELETED_TAGS=$((DELETED_TAGS + 1))
                  else
                    FAILED_TAGS=$((FAILED_TAGS + 1))
                  fi
                done
              fi
            fi
            
            # Process v* orphaned tags (excluding vscode-v*)
            mcp_orphaned=$(echo "$orphaned_tags" | grep "^v" | grep -v "^vscode-v" || echo "")
            if [ -n "$mcp_orphaned" ]; then
              mcp_orphaned_array=($(echo "$mcp_orphaned"))
              mcp_orphaned_count=${#mcp_orphaned_array[@]}
              
              if [ "$mcp_orphaned_count" -gt "$KEEP_COUNT" ]; then
                echo "  ‚ùå Deleting $((mcp_orphaned_count - KEEP_COUNT)) old v* orphaned tags"
                # Keep the last N, delete the rest
                for ((i=KEEP_COUNT; i<mcp_orphaned_count; i++)); do
                  tag="${mcp_orphaned_array[$i]}"
                  echo "     - $tag"
                  if delete_tag "$tag"; then
                    DELETED_TAGS=$((DELETED_TAGS + 1))
                  else
                    FAILED_TAGS=$((FAILED_TAGS + 1))
                  fi
                done
              fi
            fi
            
            if [ -z "$vscode_orphaned" ] && [ -z "$mcp_orphaned" ]; then
              echo "  ‚ÑπÔ∏è  No v* or vscode-v* orphaned tags found"
            fi
          else
            echo "  ‚úÖ No orphaned tags found"
          fi
          
          echo ""
          echo "‚úÖ Housekeeping complete!"
          echo ""
          echo "üìä Summary Statistics:"
          echo "  ‚úÖ Releases deleted: $DELETED_RELEASES"
          echo "  ‚úÖ Tags deleted: $DELETED_TAGS"
          if [ "$FAILED_RELEASES" -gt 0 ] || [ "$FAILED_TAGS" -gt 0 ]; then
            echo "  ‚ö†Ô∏è  Failed release deletions: $FAILED_RELEASES"
            echo "  ‚ö†Ô∏è  Failed tag deletions: $FAILED_TAGS"
            exit 1
          fi
      
      - name: Summary
        if: always()
        run: |
          echo "## üßπ Housekeeping Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Actions Performed" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Kept last 3 vscode-v* releases" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Kept last 3 v* releases (MCP/CLI)" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Cleaned up outdated GitHub releases" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Cleaned up outdated tags" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Removed orphaned tags (tags without releases)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### What Gets Deleted" >> $GITHUB_STEP_SUMMARY
          echo "This workflow automatically removes:" >> $GITHUB_STEP_SUMMARY
          echo "1. **Old Releases**: GitHub releases older than the 3 most recent (for both vscode-v* and v* patterns)" >> $GITHUB_STEP_SUMMARY
          echo "2. **Associated Tags**: Git tags for deleted releases" >> $GITHUB_STEP_SUMMARY
          echo "3. **Orphaned Tags**: Tags that exist without corresponding GitHub releases" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "üìÖ **Next scheduled run**: Every Sunday at 2 AM UTC" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "üí° **Tip**: You can also run this workflow manually using the 'Run workflow' button" >> $GITHUB_STEP_SUMMARY
