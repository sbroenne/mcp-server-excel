name: Deploy Azure Self-Hosted Runner

# This workflow deploys the Azure Windows VM for Excel integration testing
# Uses OIDC (OpenID Connect) for secure authentication - no secrets stored!
# Setup guide: infrastructure/azure/GITHUB_ACTIONS_DEPLOYMENT.md

permissions:
  contents: read
  id-token: write # Required for OIDC authentication with Azure

on:
  workflow_dispatch:
    inputs:
      resource_group:
        description: 'Azure Resource Group name'
        required: true
        default: 'rg-excel-runner'
      admin_password:
        description: 'VM Admin password (secure input)'
        required: true
        type: string

jobs:
  deploy-infrastructure:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Generate GitHub Runner Registration Token
      id: runner_token
      env:
        GH_TOKEN: ${{ secrets.RUNNER_ADMIN_PAT }}
      run: |
        # Generate runner registration token using GitHub CLI with PAT
        # Note: GITHUB_TOKEN doesn't have permission to create runner tokens
        # Requires a PAT with 'Self-hosted runners: Write' permission
        echo "🔑 Generating runner registration token..."
        
        if [ -z "$GH_TOKEN" ]; then
          echo "❌ RUNNER_ADMIN_PAT secret is not set"
          echo ""
          echo "Please create a Personal Access Token (PAT) with the following permissions:"
          echo "  - Fine-grained token: 'Self-hosted runners: Read and write'"
          echo "  - Or classic token: 'repo' scope"
          echo ""
          echo "Then add it as a repository secret named 'RUNNER_ADMIN_PAT'"
          echo "See: Settings → Secrets and variables → Actions → New repository secret"
          echo ""
          echo "Documentation: infrastructure/azure/GITHUB_ACTIONS_DEPLOYMENT.md"
          exit 1
        fi
        
        TOKEN=$(gh api \
          --method POST \
          -H "Accept: application/vnd.github+json" \
          -H "X-GitHub-Api-Version: 2022-11-28" \
          /repos/${{ github.repository }}/actions/runners/registration-token \
          --jq '.token')
        
        if [ -z "$TOKEN" ] || [ "$TOKEN" = "null" ]; then
          echo "❌ Failed to generate runner registration token"
          echo ""
          echo "This typically means:"
          echo "  1. The PAT token expired or is invalid"
          echo "  2. The PAT lacks 'Self-hosted runners: Write' permission"
          echo "  3. You don't have admin access to the repository"
          echo ""
          echo "Please verify:"
          echo "  - PAT is valid and not expired"
          echo "  - PAT has 'Self-hosted runners: Read and write' permission"
          echo "  - You are a repository admin"
          echo ""
          echo "Documentation: infrastructure/azure/GITHUB_ACTIONS_DEPLOYMENT.md"
          exit 1
        fi
        
        echo "✅ Runner registration token generated successfully"
        echo "runner_token=$TOKEN" >> $GITHUB_OUTPUT
    
    - name: Azure Login (OIDC)
      uses: azure/login@v1
      with:
        client-id: ${{ secrets.AZURE_CLIENT_ID }}
        tenant-id: ${{ secrets.AZURE_TENANT_ID }}
        subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
    
    - name: Create Resource Group
      run: |
        az group create \
          --name ${{ inputs.resource_group }} \
          --location swedencentral
    
    - name: Deploy Bicep Template
      id: deploy
      run: |
        az deployment group create \
          --resource-group ${{ inputs.resource_group }} \
          --template-file infrastructure/azure/azure-runner.bicep \
          --parameters \
            location=swedencentral \
            adminPassword='${{ inputs.admin_password }}' \
            githubRepoUrl=https://github.com/${{ github.repository }} \
            githubRunnerToken='${{ steps.runner_token.outputs.runner_token }}'
    
    - name: Get Deployment Outputs
      id: outputs
      run: |
        VM_FQDN=$(az deployment group show \
          --resource-group ${{ inputs.resource_group }} \
          --name azure-runner \
          --query 'properties.outputs.vmPublicIP.value' \
          --output tsv)
        echo "vm_fqdn=$VM_FQDN" >> $GITHUB_OUTPUT
    
    - name: Display Next Steps
      run: |
        echo "✅ Deployment complete!"
        echo ""
        echo "📋 Next Steps:"
        echo "1. RDP to VM: ${{ steps.outputs.outputs.vm_fqdn }}"
        echo "2. Username: azureuser"
        echo "3. Password: (the admin_password you provided)"
        echo "4. Install Office 365 Excel from https://portal.office.com"
        echo "5. Activate Excel with your Office 365 account"
        echo "6. Runner will auto-start after reboot"
        echo ""
        echo "💰 Monthly Cost: ~$61 in Sweden Central (24/7 operation)"
        echo ""
        echo "🔍 Verify runner status:"
        echo "   https://github.com/${{ github.repository }}/settings/actions/runners"

