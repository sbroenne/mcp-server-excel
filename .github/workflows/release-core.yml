name: Release Core

# This workflow uses NuGet Trusted Publishing via OIDC (OpenID Connect)
# The NuGet/login action exchanges GitHub OIDC tokens for short-lived NuGet API keys
# See: docs/NUGET-GUIDE.md for complete setup instructions
#
# Required GitHub Secret:
# - NUGET_USER: Your NuGet.org username (profile name, NOT email)
#
# Required NuGet.org Configuration:
# - Package: Sbroenne.ExcelMcp.Core
# - Trusted Publisher: GitHub Actions
# - Owner: sbroenne
# - Repository: mcp-server-excel
# - Workflow: release-core.yml

on:
  push:
    tags:
      - 'core-v*'

jobs:
  release-core:
    runs-on: windows-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write
      packages: write
      id-token: write  # Required for NuGet Trusted Publishing via OIDC

    steps:
    - uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 8.0.x

    - name: Update Core Version
      run: |
        $tagName = "${{ github.ref_name }}"
        $version = $tagName -replace '^core-v', ''

        Write-Output "Updating Core to version $version"

        # Update Core project version
        $csprojPath = "src/ExcelMcp.Core/ExcelMcp.Core.csproj"
        $content = Get-Content $csprojPath -Raw
        $content = $content -replace '<Version>[\d\.]+</Version>', "<Version>$version</Version>"
        $content = $content -replace '<AssemblyVersion>[\d\.]+\.[\d\.]+</AssemblyVersion>', "<AssemblyVersion>$version.0</AssemblyVersion>"
        $content = $content -replace '<FileVersion>[\d\.]+\.[\d\.]+</FileVersion>', "<FileVersion>$version.0</FileVersion>"
        Set-Content $csprojPath $content

        Write-Output "Updated Core project version to $version"

        # Set environment variable for later steps
        echo "PACKAGE_VERSION=$version" >> $env:GITHUB_ENV
      shell: pwsh

    - name: Restore dependencies
      run: dotnet restore src/ExcelMcp.Core/ExcelMcp.Core.csproj

    - name: Build Core
      run: dotnet build src/ExcelMcp.Core/ExcelMcp.Core.csproj --configuration Release --no-restore

    - name: Skip Tests (No Unit Tests - Integration tests require Excel)
      run: |
        Write-Output "‚ÑπÔ∏è ExcelMcp has no unit tests by architectural decision"
        Write-Output "   See docs/ADR-001-NO-UNIT-TESTS.md for rationale"
        Write-Output "   Integration tests run on Azure self-hosted runner with Excel"
      shell: pwsh

    - name: Pack NuGet Package
      run: dotnet pack src/ExcelMcp.Core/ExcelMcp.Core.csproj --configuration Release --no-build --output ./nupkg

    - name: NuGet login (OIDC ‚Üí temp API key)
      uses: NuGet/login@v1
      id: nuget-login
      with:
        user: ${{ secrets.NUGET_USER }}  # Your nuget.org username (profile name), NOT email

    - name: Publish to NuGet.org (Trusted Publishing)
      run: |
        $version = $env:PACKAGE_VERSION
        $packagePath = "nupkg/Sbroenne.ExcelMcp.Core.$version.nupkg"

        Write-Output "Publishing $packagePath to NuGet.org using Trusted Publishing (OIDC)..."

        dotnet nuget push $packagePath `
          --api-key ${{ steps.nuget-login.outputs.NUGET_API_KEY }} `
          --source https://api.nuget.org/v3/index.json `
          --skip-duplicate

        Write-Output "üöÄ Published Sbroenne.ExcelMcp.Core.$version to NuGet.org"
        Write-Output "üîó Package will be available at: https://www.nuget.org/packages/Sbroenne.ExcelMcp.Core/$version"
      shell: pwsh

    - name: Create GitHub Release
      run: |
        $tagName = "${{ github.ref_name }}"
        $version = $env:PACKAGE_VERSION

        # Create release notes
        $releaseNotes = "## ExcelMcp Core Library $tagName`n`n"
        $releaseNotes += "### High-Level Excel Automation Commands`n`n"
        $releaseNotes += "Core business logic library providing comprehensive Excel automation operations for Power Query, VBA, Data Model, worksheets, ranges, tables, parameters, and connections.`n`n"
        $releaseNotes += "### Key Features`n"
        $releaseNotes += "- **Power Query** (16 operations) - M code management, load destinations, privacy levels`n"
        $releaseNotes += "- **Data Model / Power Pivot** (15 operations) - DAX measures, relationships, model discovery`n"
        $releaseNotes += "- **VBA Macros** (7 operations) - Module export/import, procedure execution`n"
        $releaseNotes += "- **Excel Tables** (26 operations) - Complete table lifecycle, filtering, sorting, styling`n"
        $releaseNotes += "- **Ranges & Data** (45 operations) - Values, formulas, formatting, validation, protection`n"
        $releaseNotes += "- **Worksheets** (13 operations) - Create, rename, copy, delete, tab colors, visibility`n"
        $releaseNotes += "- **Connections** (11 operations) - OLEDB, ODBC, Text, Web connection management`n"
        $releaseNotes += "- **Named Ranges** (7 operations) - Parameter management and bulk operations`n`n"
        $releaseNotes += "### Installation`n`n"
        $releaseNotes += "**NuGet Package**`n"
        $releaseNotes += "``````powershell`n"
        $releaseNotes += "dotnet add package Sbroenne.ExcelMcp.Core --version $version`n"
        $releaseNotes += "``````n`n"
        $releaseNotes += "### Usage Example`n`n"
        $releaseNotes += "``````csharp`n"
        $releaseNotes += "using Sbroenne.ExcelMcp.Core.Commands;`n"
        $releaseNotes += "using Sbroenne.ExcelMcp.ComInterop;`n`n"
        $releaseNotes += "var powerQueryCommands = new PowerQueryCommands();`n"
        $releaseNotes += "var sheetCommands = new SheetCommands();`n`n"
        $releaseNotes += "await using var batch = await ExcelSession.BeginBatchAsync(`"workbook.xlsx`");`n`n"
        $releaseNotes += "// List Power Queries`n"
        $releaseNotes += "var queries = await powerQueryCommands.ListAsync(batch);`n"
        $releaseNotes += "foreach (var query in queries.Items) {`n"
        $releaseNotes += "    Console.WriteLine(`$`"Query: {query.Name}`");`n"
        $releaseNotes += "}`n`n"
        $releaseNotes += "// Create worksheet`n"
        $releaseNotes += "await sheetCommands.CreateAsync(batch, `"NewSheet`");`n"
        $releaseNotes += "await batch.SaveAsync();`n"
        $releaseNotes += "``````n`n"
        $releaseNotes += "### Requirements`n"
        $releaseNotes += "- Windows OS with Microsoft Excel installed`n"
        $releaseNotes += "- .NET 8.0 runtime`n"
        $releaseNotes += "- Excel 2016+ (for COM interop)`n"
        $releaseNotes += "- Sbroenne.ExcelMcp.ComInterop (included as dependency)`n`n"
        $releaseNotes += "### Related Packages`n"
        $releaseNotes += "- **Sbroenne.ExcelMcp.ComInterop** - Low-level COM interop (dependency)`n"
        $releaseNotes += "- **Sbroenne.ExcelMcp.McpServer** - MCP server for AI assistant integration`n"
        $releaseNotes += "- **Sbroenne.ExcelMcp.CLI** - Command-line tool for Excel automation`n`n"
        $releaseNotes += "### Documentation`n"
        $releaseNotes += "- NuGet Package: https://www.nuget.org/packages/Sbroenne.ExcelMcp.Core`n"
        $releaseNotes += "- GitHub Repository: https://github.com/sbroenne/mcp-server-excel`n"

        # Create the release
        gh release create "$tagName" --title "ExcelMcp Core Library $tagName" --notes $releaseNotes
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        PACKAGE_VERSION: ${{ env.PACKAGE_VERSION }}
      shell: pwsh
