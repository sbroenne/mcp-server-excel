name: Release ComInterop

# This workflow uses NuGet Trusted Publishing via OIDC (OpenID Connect)
# The NuGet/login action exchanges GitHub OIDC tokens for short-lived NuGet API keys
# See: docs/NUGET-GUIDE.md for complete setup instructions
#
# Required GitHub Secret:
# - NUGET_USER: Your NuGet.org username (profile name, NOT email)
#
# Required NuGet.org Configuration:
# - Package: Sbroenne.ExcelMcp.ComInterop
# - Trusted Publisher: GitHub Actions
# - Owner: sbroenne
# - Repository: mcp-server-excel
# - Workflow: release-cominterop.yml

on:
  push:
    tags:
      - 'cominterop-v*'

jobs:
  release-cominterop:
    runs-on: windows-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write
      packages: write
      id-token: write  # Required for NuGet Trusted Publishing via OIDC

    steps:
    - uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 8.0.x

    - name: Update ComInterop Version
      run: |
        $tagName = "${{ github.ref_name }}"
        $version = $tagName -replace '^cominterop-v', ''

        Write-Output "Updating ComInterop to version $version"

        # Update ComInterop project version
        $csprojPath = "src/ExcelMcp.ComInterop/ExcelMcp.ComInterop.csproj"
        $content = Get-Content $csprojPath -Raw
        $content = $content -replace '<Version>[\d\.]+</Version>', "<Version>$version</Version>"
        $content = $content -replace '<AssemblyVersion>[\d\.]+\.[\d\.]+</AssemblyVersion>', "<AssemblyVersion>$version.0</AssemblyVersion>"
        $content = $content -replace '<FileVersion>[\d\.]+\.[\d\.]+</FileVersion>', "<FileVersion>$version.0</FileVersion>"
        Set-Content $csprojPath $content

        Write-Output "Updated ComInterop project version to $version"

        # Set environment variable for later steps
        echo "PACKAGE_VERSION=$version" >> $env:GITHUB_ENV
      shell: pwsh

    - name: Restore dependencies
      run: dotnet restore src/ExcelMcp.ComInterop/ExcelMcp.ComInterop.csproj

    - name: Build ComInterop
      run: dotnet build src/ExcelMcp.ComInterop/ExcelMcp.ComInterop.csproj --configuration Release --no-restore

    - name: Skip Tests (No Unit Tests - Integration tests require Excel)
      run: |
        Write-Output "‚ÑπÔ∏è ExcelMcp has no unit tests by architectural decision"
        Write-Output "   See docs/ADR-001-NO-UNIT-TESTS.md for rationale"
        Write-Output "   Integration tests run on Azure self-hosted runner with Excel"
      shell: pwsh

    - name: Pack NuGet Package
      run: dotnet pack src/ExcelMcp.ComInterop/ExcelMcp.ComInterop.csproj --configuration Release --no-build --output ./nupkg

    - name: NuGet login (OIDC ‚Üí temp API key)
      uses: NuGet/login@v1
      id: nuget-login
      with:
        user: ${{ secrets.NUGET_USER }}  # Your nuget.org username (profile name), NOT email

    - name: Publish to NuGet.org (Trusted Publishing)
      run: |
        $version = $env:PACKAGE_VERSION
        $packagePath = "nupkg/Sbroenne.ExcelMcp.ComInterop.$version.nupkg"

        Write-Output "Publishing $packagePath to NuGet.org using Trusted Publishing (OIDC)..."

        dotnet nuget push $packagePath `
          --api-key ${{ steps.nuget-login.outputs.NUGET_API_KEY }} `
          --source https://api.nuget.org/v3/index.json `
          --skip-duplicate

        Write-Output "üöÄ Published Sbroenne.ExcelMcp.ComInterop.$version to NuGet.org"
        Write-Output "üîó Package will be available at: https://www.nuget.org/packages/Sbroenne.ExcelMcp.ComInterop/$version"
      shell: pwsh

    - name: Create GitHub Release
      run: |
        $tagName = "${{ github.ref_name }}"
        $version = $env:PACKAGE_VERSION

        # Create release notes
        $releaseNotes = "## ExcelMcp ComInterop Library $tagName`n`n"
        $releaseNotes += "### Low-Level COM Interop for Excel Automation`n`n"
        $releaseNotes += "Foundation library providing robust COM object lifecycle management and OLE message filtering for Excel automation.`n`n"
        $releaseNotes += "### Key Features`n"
        $releaseNotes += "- STA Threading Management - Proper single-threaded apartment model for Excel COM`n"
        $releaseNotes += "- COM Object Lifecycle - Automatic cleanup and garbage collection`n"
        $releaseNotes += "- OLE Message Filtering - Retry logic for busy Excel instances using Polly`n"
        $releaseNotes += "- Excel Session Management - Safe Excel.Application lifecycle handling`n"
        $releaseNotes += "- Batch Operations - Efficient multi-operation execution`n`n"
        $releaseNotes += "### Installation`n`n"
        $releaseNotes += "**NuGet Package**`n"
        $releaseNotes += "``````powershell`n"
        $releaseNotes += "dotnet add package Sbroenne.ExcelMcp.ComInterop --version $version`n"
        $releaseNotes += "``````n`n"
        $releaseNotes += "### Usage Example`n`n"
        $releaseNotes += "``````csharp`n"
        $releaseNotes += "using Sbroenne.ExcelMcp.ComInterop;`n`n"
        $releaseNotes += "await using var session = await ExcelSession.BeginAsync(`"workbook.xlsx`");`n"
        $releaseNotes += "await using var batch = await session.BeginBatchAsync();`n`n"
        $releaseNotes += "await batch.ExecuteAsync<int>(async (ctx, ct) => `n"
        $releaseNotes += "{`n"
        $releaseNotes += "    dynamic sheet = ctx.Book.Worksheets.Item[1];`n"
        $releaseNotes += "    sheet.Name = `"UpdatedSheet`";`n"
        $releaseNotes += "    return 0;`n"
        $releaseNotes += "});`n`n"
        $releaseNotes += "await batch.SaveAsync();`n"
        $releaseNotes += "``````n`n"
        $releaseNotes += "### Requirements`n"
        $releaseNotes += "- Windows OS with Microsoft Excel installed`n"
        $releaseNotes += "- .NET 8.0 runtime`n"
        $releaseNotes += "- Excel 2016+ (for COM interop)`n`n"
        $releaseNotes += "### Related Packages`n"
        $releaseNotes += "- **Sbroenne.ExcelMcp.Core** - High-level Excel automation commands (depends on ComInterop)`n"
        $releaseNotes += "- **Sbroenne.ExcelMcp.McpServer** - MCP server for AI assistant integration`n"
        $releaseNotes += "- **Sbroenne.ExcelMcp.CLI** - Command-line tool for Excel automation`n`n"
        $releaseNotes += "### Documentation`n"
        $releaseNotes += "- NuGet Package: https://www.nuget.org/packages/Sbroenne.ExcelMcp.ComInterop`n"
        $releaseNotes += "- GitHub Repository: https://github.com/sbroenne/mcp-server-excel`n"

        # Create the release
        gh release create "$tagName" --title "ExcelMcp ComInterop Library $tagName" --notes $releaseNotes
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        PACKAGE_VERSION: ${{ env.PACKAGE_VERSION }}
      shell: pwsh
