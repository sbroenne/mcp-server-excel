name: Build CLI

permissions:
  contents: read

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'src/ExcelMcp.CLI/**'
      - 'src/ExcelMcp.Core/**'
      - 'src/ExcelMcp.ComInterop/**'
      - 'tests/ExcelMcp.CLI.Tests/**'
      - 'tests/ExcelMcp.Core.Tests/**'
      - 'tests/ExcelMcp.ComInterop.Tests/**'
      - 'global.json'
      - 'Directory.Build.props'
      - 'Directory.Packages.props'
      - '.github/workflows/build-cli.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'src/ExcelMcp.CLI/**'
      - 'src/ExcelMcp.Core/**'
      - 'src/ExcelMcp.ComInterop/**'
      - 'tests/ExcelMcp.CLI.Tests/**'
      - 'tests/ExcelMcp.Core.Tests/**'
      - 'tests/ExcelMcp.Diagnostics.Tests/**'
      - 'tests/ExcelMcp.ComInterop.Tests/**'
      - 'global.json'
      - 'Directory.Build.props'
      - 'Directory.Packages.props'
      - '.github/workflows/build-cli.yml'

jobs:
  build-cli:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 10.0.x

    - name: Restore dependencies
      run: dotnet restore src/ExcelMcp.CLI/ExcelMcp.CLI.csproj

    - name: Build CLI
      run: dotnet build src/ExcelMcp.CLI/ExcelMcp.CLI.csproj --no-restore --configuration Release

    - name: Verify Core Commands Coverage
      run: |
        Write-Output "üîç Verifying Core Commands coverage..."
        & scripts/audit-core-coverage.ps1 -FailOnGaps
        if ($LASTEXITCODE -ne 0) {
          Write-Error "‚ùå Coverage gaps detected! All Core methods must be exposed via MCP Server."
          exit 1
        }
        Write-Output "‚úÖ Coverage audit passed - 100% coverage maintained"
      shell: pwsh

    - name: Verify CLI build
      run: |
        # Check excelcli main executable
        if (Test-Path "src/ExcelMcp.CLI/bin/Release/net10.0/excelcli.exe") {
          Write-Output "‚úÖ excelcli.exe built successfully"
          $version = (Get-Item "src/ExcelMcp.CLI/bin/Release/net10.0/excelcli.exe").VersionInfo.FileVersion
          Write-Output "Version: $version"

          # Test CLI help command (safe - no Excel COM required)
          $helpOutput = & "src/ExcelMcp.CLI/bin/Release/net10.0/excelcli.exe" --help 2>&1
          $exitCode = $LASTEXITCODE

          if ($exitCode -eq 0) {
            Write-Output "‚úÖ CLI help command working (exit code: 0)"
            Write-Output "üìã Help output preview:"
            $helpOutput | Select-Object -First 5 | ForEach-Object { Write-Output "  $_" }
          } else {
            Write-Error "‚ùå CLI help command failed with exit code: $exitCode"
            Write-Output "Full output:"
            $helpOutput | ForEach-Object { Write-Output "  $_" }
            exit 1
          }
        } else {
          Write-Error "‚ùå excelcli.exe not found"
          exit 1
        }

        Write-Output "üîß CLI tool ready for direct automation"
      shell: pwsh

    - name: Test CLI (requires Excel)
      run: |
        Write-Output "‚ÑπÔ∏è Note: CLI tests skipped in CI - they require Microsoft Excel"
        Write-Output "   Run 'dotnet test tests/ExcelMcp.CLI.Tests/' locally with Excel installed"
      shell: pwsh

    - name: Upload CLI build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ExcelMcp-CLI-${{ github.sha }}
        path: src/ExcelMcp.CLI/bin/Release/net10.0/
