name: Build MCP Server

permissions:
  contents: read

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'src/ExcelMcp.McpServer/**'
      - 'src/ExcelMcp.Core/**'
      - 'src/ExcelMcp.ComInterop/**'
      - 'tests/ExcelMcp.McpServer.Tests/**'
      - 'tests/ExcelMcp.Core.Tests/**'
      - 'tests/ExcelMcp.ComInterop.Tests/**'
      - 'global.json'
      - 'Directory.Build.props'
      - 'Directory.Packages.props'
      - '.github/workflows/build-mcp-server.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'src/ExcelMcp.McpServer/**'
      - 'src/ExcelMcp.Core/**'
      - 'src/ExcelMcp.ComInterop/**'
      - 'tests/ExcelMcp.McpServer.Tests/**'
      - 'tests/ExcelMcp.Core.Tests/**'
      - 'tests/ExcelMcp.ComInterop.Tests/**'
      - 'global.json'
      - 'Directory.Build.props'
      - 'Directory.Packages.props'
      - '.github/workflows/build-mcp-server.yml'

jobs:
  build-mcp-server:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 10.0.x

    - name: Restore dependencies
      run: dotnet restore src/ExcelMcp.McpServer/ExcelMcp.McpServer.csproj

    - name: Build MCP Server
      run: dotnet build src/ExcelMcp.McpServer/ExcelMcp.McpServer.csproj --no-restore --configuration Release

    - name: Verify Core Commands Coverage
      run: |
        Write-Output "üîç Verifying Core Commands coverage..."
        & scripts/audit-core-coverage.ps1 -FailOnGaps
        if ($LASTEXITCODE -ne 0) {
          Write-Error "‚ùå Coverage gaps detected! All Core methods must be exposed via MCP Server."
          exit 1
        }
        Write-Output "‚úÖ Coverage audit passed - 100% coverage maintained"
      shell: pwsh

    - name: Verify MCP Server build
      run: |
        # Check MCP Server executable
        if (Test-Path "src/ExcelMcp.McpServer/bin/Release/net10.0/Sbroenne.ExcelMcp.McpServer.exe") {
          Write-Output "‚úÖ Sbroenne.ExcelMcp.McpServer.exe built successfully"
          $mcpVersion = (Get-Item "src/ExcelMcp.McpServer/bin/Release/net10.0/Sbroenne.ExcelMcp.McpServer.exe").VersionInfo.FileVersion
          Write-Output "üì¶ MCP Server Version: $mcpVersion"

          # Check for MCP server.json configuration
          if (Test-Path "src/ExcelMcp.McpServer/bin/Release/net10.0/.mcp/server.json") {
            Write-Output "‚úÖ MCP server.json configuration found"
          } else {
            Write-Warning "‚ö†Ô∏è MCP server.json configuration not found"
          }
        } else {
          Write-Error "‚ùå Sbroenne.ExcelMcp.McpServer.exe not found"
          exit 1
        }

        Write-Output "üß† MCP Server ready for AI assistant integration"
      shell: pwsh

    - name: Upload MCP Server build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ExcelMcp-MCP-Server-${{ github.sha }}
        path: src/ExcelMcp.McpServer/bin/Release/net10.0/
