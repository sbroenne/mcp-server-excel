name: Release CLI

# This workflow uses NuGet Trusted Publishing via OIDC (OpenID Connect)
# The NuGet/login action exchanges GitHub OIDC tokens for short-lived NuGet API keys
# See: docs/NUGET_TRUSTED_PUBLISHING.md for setup instructions
#
# Required GitHub Secret:
# - NUGET_USER: Your NuGet.org username (profile name, NOT email)
#
# Required NuGet.org Configuration:
# - Package: Sbroenne.ExcelMcp.CLI
# - Trusted Publisher: GitHub Actions
# - Owner: sbroenne
# - Repository: mcp-server-excel
# - Workflow: release-cli.yml

on:
  push:
    tags:
      - 'cli-v*'

jobs:
  release-cli:
    runs-on: windows-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write
      packages: write
      id-token: write  # Required for NuGet Trusted Publishing via OIDC

    steps:
    - uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 8.0.x

    - name: Update CLI Version
      run: |
        $tagName = "${{ github.ref_name }}"
        $version = $tagName -replace '^cli-v', ''

        Write-Output "Updating CLI to version $version"

        # Update CLI project version
        $cliCsprojPath = "src/ExcelMcp.CLI/ExcelMcp.CLI.csproj"
        $cliContent = Get-Content $cliCsprojPath -Raw
        $cliContent = $cliContent -replace '<Version>[\d\.]+</Version>', "<Version>$version</Version>"
        $cliContent = $cliContent -replace '<AssemblyVersion>[\d\.]+\.[\d\.]+</AssemblyVersion>', "<AssemblyVersion>$version.0</AssemblyVersion>"
        $cliContent = $cliContent -replace '<FileVersion>[\d\.]+\.[\d\.]+</FileVersion>', "<FileVersion>$version.0</FileVersion>"
        Set-Content $cliCsprojPath $cliContent

        Write-Output "Updated CLI version to $version"

        # Set environment variable for later steps
        echo "PACKAGE_VERSION=$version" >> $env:GITHUB_ENV
      shell: pwsh

    - name: Restore dependencies
      run: dotnet restore src/ExcelMcp.CLI/ExcelMcp.CLI.csproj

    - name: Build CLI
      run: dotnet build src/ExcelMcp.CLI/ExcelMcp.CLI.csproj --configuration Release --no-restore

    - name: Skip Tests (No Unit Tests - Integration tests require Excel)
      run: |
        Write-Output "‚ÑπÔ∏è ExcelMcp has no unit tests by architectural decision"
        Write-Output "   See docs/ADR-001-NO-UNIT-TESTS.md for rationale"
        Write-Output "   Integration tests run on Azure self-hosted runner with Excel"
      shell: pwsh

    - name: Pack NuGet Package
      run: dotnet pack src/ExcelMcp.CLI/ExcelMcp.CLI.csproj --configuration Release --no-build --output ./nupkg

    - name: NuGet login (OIDC ‚Üí temp API key)
      uses: NuGet/login@v1
      id: nuget-login
      with:
        user: ${{ secrets.NUGET_USER }}  # Your nuget.org username (profile name), NOT email

    - name: Publish to NuGet.org (Trusted Publishing)
      run: |
        $version = $env:PACKAGE_VERSION
        $packagePath = "nupkg/Sbroenne.ExcelMcp.CLI.$version.nupkg"

        Write-Output "Publishing $packagePath to NuGet.org using Trusted Publishing (OIDC)..."

        dotnet nuget push $packagePath `
          --api-key ${{ steps.nuget-login.outputs.NUGET_API_KEY }} `
          --source https://api.nuget.org/v3/index.json `
          --skip-duplicate

        Write-Output "üöÄ Published Sbroenne.ExcelMcp.CLI.$version to NuGet.org"
        Write-Output "üîó Package will be available at: https://www.nuget.org/packages/Sbroenne.ExcelMcp.CLI/$version"
      shell: pwsh

    - name: Create CLI Release Package
      run: |
        $version = $env:PACKAGE_VERSION

        # Create release directory structure
        New-Item -ItemType Directory -Path "release" -Force
        New-Item -ItemType Directory -Path "release/ExcelMcp-CLI-$version" -Force

        # Copy CLI files
        Copy-Item "src/ExcelMcp.CLI/bin/Release/net8.0/excelcli.exe" "release/ExcelMcp-CLI-$version/"
        Copy-Item "src/ExcelMcp.CLI/bin/Release/net8.0/excelcli.dll" "release/ExcelMcp-CLI-$version/"
        Copy-Item "src/ExcelMcp.CLI/bin/Release/net8.0/Sbroenne.ExcelMcp.Core.dll" "release/ExcelMcp-CLI-$version/"
        Copy-Item "src/ExcelMcp.CLI/bin/Release/net8.0/Sbroenne.ExcelMcp.ComInterop.dll" "release/ExcelMcp-CLI-$version/"
        Copy-Item "src/ExcelMcp.CLI/bin/Release/net8.0/excelcli.runtimeconfig.json" "release/ExcelMcp-CLI-$version/"
        Copy-Item "src/ExcelMcp.CLI/bin/Release/net8.0/*.dll" "release/ExcelMcp-CLI-$version/" -Exclude "excelcli.dll", "Sbroenne.ExcelMcp.Core.dll", "Sbroenne.ExcelMcp.ComInterop.dll"

        # Copy documentation
        Copy-Item "docs/CLI.md" "release/ExcelMcp-CLI-$version/README.md"
        Copy-Item "LICENSE" "release/ExcelMcp-CLI-$version/"
        Copy-Item "docs/COMMANDS.md" "release/ExcelMcp-CLI-$version/"

        # Create quick start guide
        $quickStartContent = "# ExcelMcp CLI v$version`n`n"
        $quickStartContent += "## Quick Start`n`n"
        $quickStartContent += "### Basic Usage`n"
        $quickStartContent += "``````powershell`n"
        $quickStartContent += "# Show help`n"
        $quickStartContent += ".\excelcli.exe`n`n"
        $quickStartContent += "# Create empty workbook`n"
        $quickStartContent += ".\excelcli.exe create-empty `"test.xlsx`"`n`n"
        $quickStartContent += "# List Power Queries`n"
        $quickStartContent += ".\excelcli.exe pq-list `"workbook.xlsx`"`n`n"
        $quickStartContent += "# Read worksheet data`n"
        $quickStartContent += ".\excelcli.exe sheet-read `"workbook.xlsx`" `"Sheet1`" `"A1:D10`"`n"
        $quickStartContent += "``````n`n"
        $quickStartContent += "### VBA Operations (One-time setup)`n"
        $quickStartContent += "``````powershell`n"
        $quickStartContent += "# Enable VBA trust (run once)`n"
        $quickStartContent += ".\excelcli.exe setup-vba-trust`n`n"
        $quickStartContent += "# Create macro-enabled workbook`n"
        $quickStartContent += ".\excelcli.exe create-empty `"macros.xlsm`"`n`n"
        $quickStartContent += "# List VBA modules`n"
        $quickStartContent += ".\excelcli.exe script-list `"macros.xlsm`"`n"
        $quickStartContent += "``````n`n"
        $quickStartContent += "## Documentation`n`n"
        $quickStartContent += "- **README.md** - Complete CLI documentation`n"
        $quickStartContent += "- **COMMANDS.md** - All 40+ command reference`n"
        $quickStartContent += "- **GitHub**: https://github.com/sbroenne/mcp-server-excel`n`n"
        $quickStartContent += "## Requirements`n`n"
        $quickStartContent += "- Windows OS with Microsoft Excel installed`n"
        $quickStartContent += "- .NET 8.0 runtime`n"
        $quickStartContent += "- Excel 2016+ (for COM interop)`n`n"
        $quickStartContent += "## Features`n`n"
        $quickStartContent += "- 89 Excel automation commands`n"
        $quickStartContent += "- Power Query development tools`n"
        $quickStartContent += "- VBA development and execution`n"
        $quickStartContent += "- Worksheet and table data manipulation`n"
        $quickStartContent += "- Data Model operations (DAX measures, relationships, calculated columns)`n"
        $quickStartContent += "- Range operations (values, formulas, clear variants)`n"
        $quickStartContent += "- Named range parameter management`n"
        $quickStartContent += "- Connection management`n`n"
        $quickStartContent += "## License`n`n"
        $quickStartContent += "MIT License - see LICENSE file for details.`n"

        Set-Content "release/ExcelMcp-CLI-$version/QUICK-START.md" $quickStartContent

        # Create ZIP
        Compress-Archive -Path "release/ExcelMcp-CLI-$version/*" -DestinationPath "ExcelMcp-CLI-$version-windows.zip"

        Write-Output "Created ExcelMcp-CLI-$version-windows.zip"
      shell: pwsh

    - name: Create GitHub Release
      run: |
        $tagName = "${{ github.ref_name }}"
        $version = $env:PACKAGE_VERSION

        # Create release notes
        $releaseNotes = "## ExcelMcp CLI $tagName`n`n"
        $releaseNotes += "### Command-Line Interface for Excel Automation`n`n"
        $releaseNotes += "Direct command-line access to Excel operations for automation workflows, development, and CI/CD integration.`n`n"
        $releaseNotes += "### Key Features`n"
        $releaseNotes += "- 89 Excel automation commands`n"
        $releaseNotes += "- Power Query development tools (M code management)`n"
        $releaseNotes += "- VBA development and macro execution`n"
        $releaseNotes += "- Worksheet and table data manipulation`n"
        $releaseNotes += "- Data Model operations (DAX measures, relationships, calculated columns)`n"
        $releaseNotes += "- Range operations (values, formulas, clear variants)`n"
        $releaseNotes += "- Named range parameter management`n"
        $releaseNotes += "- Connection management (OLEDB, ODBC, Text, Web)`n"
        $releaseNotes += "- CI/CD integration ready`n`n"
        $releaseNotes += "### Installation`n`n"
        $releaseNotes += "**Option 1: .NET Tool (Recommended)**`n"
        $releaseNotes += "``````powershell`n"
        $releaseNotes += "# Install globally`n"
        $releaseNotes += "dotnet tool install --global Sbroenne.ExcelMcp.CLI --version $version`n`n"
        $releaseNotes += "# Run CLI`n"
        $releaseNotes += "excelcli`n`n"
        $releaseNotes += "# Update`n"
        $releaseNotes += "dotnet tool update --global Sbroenne.ExcelMcp.CLI`n"
        $releaseNotes += "``````n`n"
        $releaseNotes += "**Option 2: Download Binary**`n"
        $releaseNotes += "1. Download ExcelMcp-CLI-$version-windows.zip`n"
        $releaseNotes += "2. Extract to your preferred directory`n"
        $releaseNotes += "3. See QUICK-START.md for usage examples`n`n"
        $releaseNotes += "### Command Categories`n"
        $releaseNotes += "- **File Operations** (1) - Create Excel workbooks (.xlsx, .xlsm)`n"
        $releaseNotes += "- **Power Query** (9) - M code management and data transformation`n"
        $releaseNotes += "- **VBA Scripts** (7) - Macro development and execution`n"
        $releaseNotes += "- **Worksheets** (5) - Sheet lifecycle management`n"
        $releaseNotes += "- **Range Operations** (7) - Get/set values/formulas, clear variants`n"
        $releaseNotes += "- **Tables** (20) - Complete table lifecycle and data operations`n"
        $releaseNotes += "- **Parameters** (6) - Named range configuration`n"
        $releaseNotes += "- **Connections** (11) - Connection management (OLEDB, ODBC, Text, Web)`n"
        $releaseNotes += "- **Data Model** (16) - DAX measures, relationships, calculated columns`n"
        $releaseNotes += "- **Cell Operations** (4) - Individual cell get/set`n`n"
        $releaseNotes += "### Quick Examples`n"
        $releaseNotes += "``````powershell`n"
        $releaseNotes += "# Basic operations`n"
        $releaseNotes += "excelcli.exe create-empty `"test.xlsx`"`n"
        $releaseNotes += "excelcli.exe pq-list `"workbook.xlsx`"`n"
        $releaseNotes += "excelcli.exe sheet-read `"workbook.xlsx`" `"Sheet1`" `"A1:D10`"`n`n"
        $releaseNotes += "# VBA operations (requires setup-vba-trust)`n"
        $releaseNotes += "excelcli.exe setup-vba-trust`n"
        $releaseNotes += "excelcli.exe script-list `"macros.xlsm`"`n"
        $releaseNotes += "excelcli.exe script-run `"macros.xlsm`" `"Module.Procedure`"`n"
        $releaseNotes += "``````n`n"
        $releaseNotes += "### Requirements`n"
        $releaseNotes += "- Windows OS with Microsoft Excel installed`n"
        $releaseNotes += "- .NET 8.0 runtime`n"
        $releaseNotes += "- Excel 2016+ (for COM interop)`n`n"
        $releaseNotes += "### Documentation`n"
        $releaseNotes += "- Complete Command Reference: COMMANDS.md in package`n"
        $releaseNotes += "- GitHub Repository: https://github.com/sbroenne/mcp-server-excel`n"
        $releaseNotes += "- CLI Documentation: docs/CLI.md`n`n"
        $releaseNotes += "### Related Tools`n"
        $releaseNotes += "- ExcelMcp MCP Server: For AI assistant integration`n"
        $releaseNotes += "- GitHub Copilot Integration: AI-assisted development workflows`n"

        # Create the release
        gh release create "$tagName" "ExcelMcp-CLI-$version-windows.zip" --title "ExcelMcp CLI $tagName" --notes $releaseNotes
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        PACKAGE_VERSION: ${{ env.PACKAGE_VERSION }}
      shell: pwsh
