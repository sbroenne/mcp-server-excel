name: Release MCP Server & CLI

# This workflow uses NuGet Trusted Publishing via OIDC (OpenID Connect)
# The NuGet/login action exchanges GitHub OIDC tokens for short-lived NuGet API keys
# See: docs/NUGET-GUIDE.md for complete setup instructions
#
# Unified Versioning: MCP Server and CLI always release together with the same version
# Tag pattern: v1.2.3 (removes mcp-v prefix, CLI and MCP Server share version)
#
# Required GitHub Secret:
# - NUGET_USER: Your NuGet.org username (profile name, NOT email)
#
# Required NuGet.org Configuration:
# - Package: Sbroenne.ExcelMcp.McpServer
# - Package: Sbroenne.ExcelMcp.CLI
# - Trusted Publisher: GitHub Actions
# - Owner: sbroenne
# - Repository: mcp-server-excel
# - Workflow: release-mcp-server.yml
#
# MCP Registry Publishing:
# - MCP Registry steps use continue-on-error to ensure NuGet publishing succeeds
# - If MCP Registry validation fails, the workflow continues and completes
# - Check "MCP Registry Status" step output for publishing status
# - NuGet package is always published regardless of MCP Registry status

on:
  push:
    tags:
      - 'v*'  # Unified version tag (e.g., v1.2.3)
      - '!vscode-v*'  # Exclude VS Code extension tags

jobs:
  release-mcp-and-cli:
    runs-on: windows-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write
      packages: write
      id-token: write  # Required for NuGet Trusted Publishing via OIDC

    steps:
    - uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 8.0.x

    - name: Update Versions (MCP Server & CLI)
      run: |
        $tagName = "${{ github.ref_name }}"
        $version = $tagName -replace '^v', ''

        Write-Output "Updating MCP Server and CLI to unified version $version"

        # Update MCP Server project version
        $mcpCsprojPath = "src/ExcelMcp.McpServer/ExcelMcp.McpServer.csproj"
        $mcpContent = Get-Content $mcpCsprojPath -Raw
        $mcpContent = $mcpContent -replace '<Version>[\d\.]+</Version>', "<Version>$version</Version>"
        $mcpContent = $mcpContent -replace '<AssemblyVersion>[\d\.]+\.[\d\.]+</AssemblyVersion>', "<AssemblyVersion>$version.0</AssemblyVersion>"
        $mcpContent = $mcpContent -replace '<FileVersion>[\d\.]+\.[\d\.]+</FileVersion>', "<FileVersion>$version.0</FileVersion>"
        Set-Content $mcpCsprojPath $mcpContent

        # Update CLI project version
        $cliCsprojPath = "src/ExcelMcp.CLI/ExcelMcp.CLI.csproj"
        $cliContent = Get-Content $cliCsprojPath -Raw
        $cliContent = $cliContent -replace '<Version>[\d\.]+</Version>', "<Version>$version</Version>"
        $cliContent = $cliContent -replace '<AssemblyVersion>[\d\.]+\.[\d\.]+</AssemblyVersion>', "<AssemblyVersion>$version.0</AssemblyVersion>"
        $cliContent = $cliContent -replace '<FileVersion>[\d\.]+\.[\d\.]+</FileVersion>', "<FileVersion>$version.0</FileVersion>"
        Set-Content $cliCsprojPath $cliContent

        # Update MCP Server configuration
        $serverJsonPath = "src/ExcelMcp.McpServer/.mcp/server.json"
        $serverContent = Get-Content $serverJsonPath -Raw

        # Update main version field (near top of file, not in _meta section)
        $serverContent = $serverContent -replace '(\s*"version":\s*)"[\d\.]+"(\s*,\s*\n\s*"title")' , "`$1`"$version`"`$2"

        # Update package version in packages array (specifically after identifier field)
        $serverContent = $serverContent -replace '("identifier":\s*"Sbroenne\.ExcelMcp\.McpServer",\s*\n\s*"version":\s*)"[\d\.]+"', "`$1`"$version`""

        Set-Content $serverJsonPath $serverContent

        Write-Output "‚úÖ Updated MCP Server project and configuration to $version"
        Write-Output "‚úÖ Updated CLI project to $version"

        # Set environment variable for later steps
        echo "PACKAGE_VERSION=$version" >> $env:GITHUB_ENV
      shell: pwsh

    - name: Restore dependencies
      run: |
        dotnet restore src/ExcelMcp.McpServer/ExcelMcp.McpServer.csproj
        dotnet restore src/ExcelMcp.CLI/ExcelMcp.CLI.csproj

    - name: Build MCP Server & CLI
      run: |
        dotnet build src/ExcelMcp.McpServer/ExcelMcp.McpServer.csproj --configuration Release --no-restore
        dotnet build src/ExcelMcp.CLI/ExcelMcp.CLI.csproj --configuration Release --no-restore

    - name: Skip Tests (require Excel)
      run: |
        Write-Output "‚ÑπÔ∏è Note: Tests skipped in CI - they require Microsoft Excel"
        Write-Output "   All tests are Integration tests that need Excel COM interop"
        Write-Output "   Run tests locally with Excel installed or on Azure self-hosted runner"
      shell: pwsh

    - name: Pack NuGet Packages
      run: |
        dotnet pack src/ExcelMcp.McpServer/ExcelMcp.McpServer.csproj --configuration Release --no-build --output ./nupkg
        dotnet pack src/ExcelMcp.CLI/ExcelMcp.CLI.csproj --configuration Release --no-build --output ./nupkg

    - name: NuGet login (OIDC ‚Üí temp API key)
      uses: NuGet/login@v1
      id: nuget-login
      with:
        user: ${{ secrets.NUGET_USER }}  # Your nuget.org username (profile name), NOT email

    - name: Publish MCP Server to NuGet.org
      run: |
        $version = $env:PACKAGE_VERSION
        $packagePath = "nupkg/Sbroenne.ExcelMcp.McpServer.$version.nupkg"

        Write-Output "Publishing $packagePath to NuGet.org using Trusted Publishing (OIDC)..."

        dotnet nuget push $packagePath `
          --api-key ${{ steps.nuget-login.outputs.NUGET_API_KEY }} `
          --source https://api.nuget.org/v3/index.json `
          --skip-duplicate

        Write-Output "üöÄ Published Sbroenne.ExcelMcp.McpServer.$version to NuGet.org"
        Write-Output "üîó Package: https://www.nuget.org/packages/Sbroenne.ExcelMcp.McpServer/$version"
      shell: pwsh

    - name: Publish CLI to NuGet.org
      run: |
        $version = $env:PACKAGE_VERSION
        $packagePath = "nupkg/Sbroenne.ExcelMcp.CLI.$version.nupkg"

        Write-Output "Publishing $packagePath to NuGet.org using Trusted Publishing (OIDC)..."

        dotnet nuget push $packagePath `
          --api-key ${{ steps.nuget-login.outputs.NUGET_API_KEY }} `
          --source https://api.nuget.org/v3/index.json `
          --skip-duplicate

        Write-Output "üöÄ Published Sbroenne.ExcelMcp.CLI.$version to NuGet.org"
        Write-Output "üîó Package: https://www.nuget.org/packages/Sbroenne.ExcelMcp.CLI/$version"
      shell: pwsh

    - name: Wait for NuGet Package Propagation
      run: |
        $version = $env:PACKAGE_VERSION
        $packageId = "sbroenne.excelmcp.mcpserver"
        $readmeUrl = "https://api.nuget.org/v3-flatcontainer/$packageId/$version/readme"

        Write-Output "Waiting for NuGet CDN to propagate package README..."
        Write-Output "Checking: $readmeUrl"

        $maxAttempts = 3  # 3 attempts * 10 minutes = 30 minutes max (safe margin for NuGet propagation)
        $pollIntervalSeconds = 600  # 10 minutes between polls
        $attempt = 0
        $found = $false

        while ($attempt -lt $maxAttempts -and -not $found) {
          $attempt++
          Write-Output "Attempt $attempt of $maxAttempts..."

          try {
            $response = Invoke-WebRequest -Uri $readmeUrl -UseBasicParsing -ErrorAction SilentlyContinue
            if ($response.StatusCode -eq 200) {
              $content = $response.Content
              if ($content -match "mcp-name:\s+io\.github\.sbroenne/mcp-server-excel") {
                Write-Output "‚úÖ README found and contains mcp-name validation string!"
                $found = $true
              } else {
                Write-Output "‚ö†Ô∏è README found but mcp-name string not detected yet"
              }
            }
          } catch {
            Write-Output "README not yet available (expected during propagation)"
          }

          if (-not $found -and $attempt -lt $maxAttempts) {
            Write-Output "Waiting $pollIntervalSeconds seconds (10 minutes) before next check..."
            Start-Sleep -Seconds $pollIntervalSeconds
          }
        }

        if ($found) {
          Write-Output "‚úÖ NuGet package README is propagated and ready for MCP Registry validation"
        } else {
          Write-Output "‚ö†Ô∏è README propagation taking longer than expected, but continuing..."
          Write-Output "   MCP Registry publish may need to be retried manually if validation fails"
        }
      shell: pwsh
      env:
        PACKAGE_VERSION: ${{ env.PACKAGE_VERSION }}

    - name: Install MCP Publisher
      id: install-mcp-publisher
      continue-on-error: true
      run: |
        Write-Output "Installing MCP Publisher CLI..."
        $arch = if ([System.Runtime.InteropServices.RuntimeInformation]::ProcessArchitecture -eq "Arm64") { "arm64" } else { "amd64" }
        Invoke-WebRequest -Uri "https://github.com/modelcontextprotocol/registry/releases/latest/download/mcp-publisher_windows_$arch.tar.gz" -OutFile "mcp-publisher.tar.gz"
        tar xf mcp-publisher.tar.gz mcp-publisher.exe
        Remove-Item mcp-publisher.tar.gz
        Write-Output "‚úì MCP Publisher installed"
      shell: pwsh

    - name: Login to MCP Registry
      id: login-mcp-registry
      continue-on-error: true
      if: steps.install-mcp-publisher.outcome == 'success'
      run: |
        Write-Output "Authenticating with MCP Registry using GitHub OIDC..."
        ./mcp-publisher.exe login github-oidc
        Write-Output "‚úì Authenticated with MCP Registry"
      shell: pwsh

    - name: Publish to MCP Registry
      id: publish-mcp-registry
      continue-on-error: true
      if: steps.login-mcp-registry.outcome == 'success'
      run: |
        $version = $env:PACKAGE_VERSION
        $packageId = "sbroenne.excelmcp.mcpserver"

        Write-Output "Publishing to MCP Registry..."
        Write-Output "Server name: io.github.sbroenne/mcp-server-excel"
        Write-Output "Package ID: $packageId"
        Write-Output "Version: $version"
        Write-Output ""

        # Verify README is accessible before publishing
        $readmeUrl = "https://api.nuget.org/v3-flatcontainer/$packageId/$version/readme"
        Write-Output "Pre-publish verification:"
        Write-Output "Checking README at: $readmeUrl"

        try {
          $readmeContent = Invoke-WebRequest -Uri $readmeUrl -UseBasicParsing | Select-Object -ExpandProperty Content
          if ($readmeContent -match "mcp-name:\s+io\.github\.sbroenne/mcp-server-excel") {
            Write-Output "‚úÖ README contains mcp-name validation string"
          } else {
            Write-Output "‚ö†Ô∏è README found but mcp-name string not detected - publishing may fail validation"
          }
        } catch {
          Write-Output "‚ö†Ô∏è Could not verify README accessibility - publishing may fail validation"
        }

        Write-Output ""
        Write-Output "Proceeding with MCP Registry publish..."

        # Navigate to MCP Server .mcp directory (where server.json is located)
        Set-Location src/ExcelMcp.McpServer/.mcp

        # Publish to registry (verbose mode for debugging)
        ../../../mcp-publisher.exe publish --verbose

        Write-Output "üöÄ Published to MCP Registry"
        Write-Output "üîó Server available at: https://registry.modelcontextprotocol.io/servers/io.github.sbroenne/mcp-server-excel"
      shell: pwsh
      env:
        PACKAGE_VERSION: ${{ env.PACKAGE_VERSION }}

    - name: MCP Registry Status
      if: always()
      run: |
        Write-Output "========================================"
        Write-Output "MCP Registry Publishing Status Summary"
        Write-Output "========================================"

        $installStatus = "${{ steps.install-mcp-publisher.outcome }}"
        $loginStatus = "${{ steps.login-mcp-registry.outcome }}"
        $publishStatus = "${{ steps.publish-mcp-registry.outcome }}"

        Write-Output "Install MCP Publisher: $installStatus"
        Write-Output "Login to MCP Registry: $loginStatus"
        Write-Output "Publish to MCP Registry: $publishStatus"
        Write-Output ""

        if ($publishStatus -eq "success") {
          Write-Output "‚úÖ MCP Registry publishing succeeded!"
          Write-Output "üîó Server available at: https://registry.modelcontextprotocol.io/servers/io.github.sbroenne/mcp-server-excel"
        } else {
          Write-Output "‚ö†Ô∏è MCP Registry publishing did not complete successfully"
          Write-Output "   This does not affect NuGet package availability"
          Write-Output "   NuGet package: https://www.nuget.org/packages/Sbroenne.ExcelMcp.McpServer"
          Write-Output ""
          Write-Output "   Known issue: MCP Registry validation may fail despite correct README format"
          Write-Output "   See: https://github.com/sbroenne/mcp-server-excel/issues/XXX"
        }

        Write-Output "========================================"
      shell: pwsh

    - name: Create MCP Server Release Package
      run: |
        $version = $env:PACKAGE_VERSION

        # Create release directory structure
        New-Item -ItemType Directory -Path "release" -Force
        New-Item -ItemType Directory -Path "release/ExcelMcp-MCP-Server-$version" -Force

        # Copy MCP Server files
        Copy-Item "src/ExcelMcp.McpServer/bin/Release/net8.0/*" "release/ExcelMcp-MCP-Server-$version/" -Recurse

        # Copy documentation
        Copy-Item "README.md" "release/ExcelMcp-MCP-Server-$version/"
        Copy-Item "LICENSE" "release/ExcelMcp-MCP-Server-$version/"
        Copy-Item "src/ExcelMcp.McpServer/README.md" "release/ExcelMcp-MCP-Server-$version/MCP-SERVER-README.md"

        # Create installation README with proper content
        $readmeContent = "# ExcelMcp MCP Server v$version`n`n"
        $readmeContent += "## Quick Start`n`n"
        $readmeContent += "### Option 1: Install as .NET Tool (Recommended)`n"
        $readmeContent += "``````powershell`n"
        $readmeContent += "# Install globally`n"
        $readmeContent += "dotnet tool install --global Sbroenne.ExcelMcp.McpServer --version $version`n`n"
        $readmeContent += "# Run MCP server`n"
        $readmeContent += "mcp-excel`n`n"
        $readmeContent += "# Update`n"
        $readmeContent += "dotnet tool update --global Sbroenne.ExcelMcp.McpServer`n"
        $readmeContent += "``````n`n"
        $readmeContent += "### Option 2: Run from Binary`n"
        $readmeContent += "``````powershell`n"
        $readmeContent += "dotnet ExcelMcp.McpServer.dll`n"
        $readmeContent += "``````n`n"
        $readmeContent += "## Features`n`n"
        $readmeContent += "- AI Assistant Integration - Native MCP protocol support`n"
        $readmeContent += "- Conversational Interface - Natural language Excel operations`n"
        $readmeContent += "- 12 Resource-Based Tools - Structured API for AI assistants`n"
        $readmeContent += "- Excel Development Focus - Power Query, VBA, Data Model, tables, ranges, worksheets`n`n"
        $readmeContent += "## Requirements`n`n"
        $readmeContent += "- Windows OS with Microsoft Excel installed`n"
        $readmeContent += "- .NET 8.0 runtime`n"
        $readmeContent += "- Excel 2016+ (for COM interop)`n`n"
        $readmeContent += "## License`n`n"
        $readmeContent += "MIT License - see LICENSE file for details.`n"

        Set-Content "release/ExcelMcp-MCP-Server-$version/README.md" $readmeContent

        # Create ZIP
        Compress-Archive -Path "release/ExcelMcp-MCP-Server-$version/*" -DestinationPath "ExcelMcp-MCP-Server-$version-windows.zip"

        Write-Output "Created ExcelMcp-MCP-Server-$version-windows.zip"
      shell: pwsh

    - name: Create CLI Release Package
      run: |
        $version = $env:PACKAGE_VERSION

        # Create CLI release directory
        New-Item -ItemType Directory -Path "release/ExcelMcp-CLI-$version" -Force

        # Copy CLI files
        Copy-Item "src/ExcelMcp.CLI/bin/Release/net8.0/*" "release/ExcelMcp-CLI-$version/" -Recurse

        # Copy documentation
        Copy-Item "README.md" "release/ExcelMcp-CLI-$version/"
        Copy-Item "LICENSE" "release/ExcelMcp-CLI-$version/"
        Copy-Item "src/ExcelMcp.CLI/README.md" "release/ExcelMcp-CLI-$version/CLI-README.md"

        # Create installation README
        $cliReadme = "# ExcelMcp CLI v$version`n`n"
        $cliReadme += "## Quick Start`n`n"
        $cliReadme += "### Option 1: Install as .NET Tool (Recommended)`n"
        $cliReadme += "``````powershell`n"
        $cliReadme += "# Install globally`n"
        $cliReadme += "dotnet tool install --global Sbroenne.ExcelMcp.CLI --version $version`n`n"
        $cliReadme += "# Run CLI`n"
        $cliReadme += "excelcli --help`n`n"
        $cliReadme += "# Update`n"
        $cliReadme += "dotnet tool update --global Sbroenne.ExcelMcp.CLI`n"
        $cliReadme += "``````n`n"
        $cliReadme += "### Option 2: Run from Binary`n"
        $cliReadme += "``````powershell`n"
        $cliReadme += "dotnet ExcelMcp.CLI.dll --help`n"
        $cliReadme += "``````n`n"
        $cliReadme += "## Features`n`n"
        $cliReadme += "- 147 Commands - Comprehensive Excel automation`n"
        $cliReadme += "- Batch Operations - Multiple operations in single Excel session`n"
        $cliReadme += "- Scriptable - Perfect for CI/CD and automation`n"
        $cliReadme += "- Zero Corruption - Safe COM interop with proper cleanup`n`n"
        $cliReadme += "## Requirements`n`n"
        $cliReadme += "- Windows OS with Microsoft Excel installed`n"
        $cliReadme += "- .NET 8.0 runtime`n"
        $cliReadme += "- Excel 2016+ (for COM interop)`n`n"
        $cliReadme += "## License`n`n"
        $cliReadme += "MIT License - see LICENSE file for details.`n"

        Set-Content "release/ExcelMcp-CLI-$version/README.md" $cliReadme

        # Create ZIP
        Compress-Archive -Path "release/ExcelMcp-CLI-$version/*" -DestinationPath "ExcelMcp-CLI-$version-windows.zip"

        Write-Output "Created ExcelMcp-CLI-$version-windows.zip"
      shell: pwsh

    - name: Create GitHub Release
      run: |
        $tagName = "${{ github.ref_name }}"
        $version = $env:PACKAGE_VERSION

        # Create release notes
        $releaseNotes = "## ExcelMcp v$version - MCP Server & CLI`n`n"
        $releaseNotes += "Unified release: MCP Server and CLI share the same version for consistency.`n`n"
        $releaseNotes += "### MCP Server - AI-Powered Excel Development`n`n"
        $releaseNotes += "The Model Context Protocol (MCP) Server enables AI assistants like GitHub Copilot, Claude, and ChatGPT to perform Excel development tasks through conversational interfaces.`n`n"
        $releaseNotes += "### Key Features`n"
        $releaseNotes += "- Native AI Integration - Built for GitHub Copilot and AI assistants`n"
        $releaseNotes += "- Conversational Excel - Natural language Excel operations`n"
        $releaseNotes += "- Resource-Based API - 12 structured tools for comprehensive Excel automation`n"
        $releaseNotes += "- Development Focus - Power Query refactoring, VBA enhancement, Data Model operations, table management, range operations`n"
        $releaseNotes += "- Smart Context - AI understands Excel development workflows`n`n"
        $releaseNotes += "### Installation`n`n"
        $releaseNotes += "**Option 1: .NET Tool (Recommended)**`n"
        $releaseNotes += "``````powershell`n"
        $releaseNotes += "dotnet tool install --global Sbroenne.ExcelMcp.McpServer --version $version`n"
        $releaseNotes += "mcp-excel`n"
        $releaseNotes += "``````n`n"
        $releaseNotes += "**Option 2: Download Binary**`n"
        $releaseNotes += "1. Download ExcelMcp-MCP-Server-$version-windows.zip`n"
        $releaseNotes += "2. Extract and run: dotnet ExcelMcp.McpServer.dll`n`n"
        $releaseNotes += "### MCP Tools Available`n"
        $releaseNotes += "- excel_file - File management (create-empty, close-workbook)`n"
        $releaseNotes += "- excel_powerquery - Power Query operations (list, view, import, export, update, refresh, delete, set-load-config, get-load-config)`n"
        $releaseNotes += "- excel_worksheet - Worksheet operations (list, create, rename, copy, delete)`n"
        $releaseNotes += "- excel_range - Range operations (get-values, set-values, get-formulas, set-formulas, clear-all, clear-contents, clear-formats)`n"
        $releaseNotes += "- excel_table - Table operations (list, create, info, rename, delete, resize, set-style, toggle-totals, set-column-total, append, apply-filter, clear-filters, get-filters, add-column, remove-column, rename-column, sort, add-to-datamodel, get-structured-reference)`n"
        $releaseNotes += "- excel_parameter - Named range management (list, get, set, create, delete, update)`n"
        $releaseNotes += "- excel_cell - Cell operations (get-value, set-value, get-formula, set-formula)`n"
        $releaseNotes += "- excel_connection - Connection management (list, view, import, export, update, refresh, delete, loadto, properties, set-properties, test)`n"
        $releaseNotes += "- excel_datamodel - Data Model operations (list-tables, list-measures, view-measure, export-measure, list-relationships, refresh, delete-measure, delete-relationship)`n"
        $releaseNotes += "- excel_vba - VBA script management (list, export, import, view, update, run, delete)`n"
        $releaseNotes += "- excel_batch - Batch operation management (begin, commit, list)`n`n"
        $releaseNotes += "### CLI - Scriptable Excel Automation`n`n"
        $releaseNotes += "Command-line interface with 147 commands for Excel automation, perfect for CI/CD pipelines and scripting.`n`n"
        $releaseNotes += "### CLI Installation`n`n"
        $releaseNotes += "**Option 1: .NET Tool (Recommended)**`n"
        $releaseNotes += "``````powershell`n"
        $releaseNotes += "dotnet tool install --global Sbroenne.ExcelMcp.CLI --version $version`n"
        $releaseNotes += "excelcli --help`n"
        $releaseNotes += "``````n`n"
        $releaseNotes += "**Option 2: Download Binary**`n"
        $releaseNotes += "1. Download ExcelMcp-CLI-$version-windows.zip`n"
        $releaseNotes += "2. Extract and run: dotnet ExcelMcp.CLI.dll --help`n`n"
        $releaseNotes += "### Requirements`n"
        $releaseNotes += "- Windows OS with Microsoft Excel installed`n"
        $releaseNotes += "- .NET 8.0 runtime`n"
        $releaseNotes += "- Excel 2016+ (for COM interop)`n`n"
        $releaseNotes += "### Documentation`n"
        $releaseNotes += "- GitHub Repository: https://github.com/sbroenne/mcp-server-excel`n"
        $releaseNotes += "- MCP Server: src/ExcelMcp.McpServer/README.md`n"
        $releaseNotes += "- CLI: src/ExcelMcp.CLI/README.md`n"

        # Create the release with both packages
        gh release create "$tagName" `
          "ExcelMcp-MCP-Server-$version-windows.zip" `
          "ExcelMcp-CLI-$version-windows.zip" `
          --title "ExcelMcp v$version - MCP Server & CLI" `
          --notes $releaseNotes
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        PACKAGE_VERSION: ${{ env.PACKAGE_VERSION }}
      shell: pwsh
