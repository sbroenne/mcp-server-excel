name: Release MCP Server & CLI

# This workflow uses NuGet Trusted Publishing via OIDC (OpenID Connect)
# The NuGet/login action exchanges GitHub OIDC tokens for short-lived NuGet API keys
# See: docs/NUGET-GUIDE.md for complete setup instructions
#
# Unified Versioning: MCP Server and CLI always release together with the same version
# Tag pattern: v1.2.3 (removes mcp-v prefix, CLI and MCP Server share version)
#
# Required GitHub Secrets:
# - NUGET_USER: Your NuGet.org username (profile name, NOT email)
# - APPINSIGHTS_CONNECTION_STRING: Application Insights connection string for telemetry
#
# Required NuGet.org Configuration:
# - Package: Sbroenne.ExcelMcp.McpServer
# - Package: Sbroenne.ExcelMcp.CLI
# - Trusted Publisher: GitHub Actions
# - Owner: sbroenne
# - Repository: mcp-server-excel
# - Workflow: release-mcp-server.yml
#
# MCP Registry Publishing:
# - MCP Registry steps use continue-on-error to ensure NuGet publishing succeeds
# - If MCP Registry validation fails, the workflow continues and completes
# - Check "MCP Registry Status" step output for publishing status
# - NuGet package is always published regardless of MCP Registry status

on:
  push:
    tags:
      - 'v*'  # Unified version tag (e.g., v1.2.3)
      - '!vscode-v*'  # Exclude VS Code extension tags

jobs:
  release-mcp-and-cli:
    runs-on: windows-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write
      packages: write
      id-token: write  # Required for NuGet Trusted Publishing via OIDC

    steps:
    - uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 8.0.x

    - name: Update Versions (MCP Server & CLI)
      run: |
        $tagName = "${{ github.ref_name }}"
        $version = $tagName -replace '^v', ''

        Write-Output "Updating MCP Server and CLI to unified version $version"

        # Update MCP Server project version
        $mcpCsprojPath = "src/ExcelMcp.McpServer/ExcelMcp.McpServer.csproj"
        $mcpContent = Get-Content $mcpCsprojPath -Raw
        $mcpContent = $mcpContent -replace '<Version>[\d\.]+</Version>', "<Version>$version</Version>"
        $mcpContent = $mcpContent -replace '<AssemblyVersion>[\d\.]+\.[\d\.]+</AssemblyVersion>', "<AssemblyVersion>$version.0</AssemblyVersion>"
        $mcpContent = $mcpContent -replace '<FileVersion>[\d\.]+\.[\d\.]+</FileVersion>', "<FileVersion>$version.0</FileVersion>"
        Set-Content $mcpCsprojPath $mcpContent

        # Update CLI project version
        $cliCsprojPath = "src/ExcelMcp.CLI/ExcelMcp.CLI.csproj"
        $cliContent = Get-Content $cliCsprojPath -Raw
        $cliContent = $cliContent -replace '<Version>[\d\.]+</Version>', "<Version>$version</Version>"
        $cliContent = $cliContent -replace '<AssemblyVersion>[\d\.]+\.[\d\.]+</AssemblyVersion>', "<AssemblyVersion>$version.0</AssemblyVersion>"
        $cliContent = $cliContent -replace '<FileVersion>[\d\.]+\.[\d\.]+</FileVersion>', "<FileVersion>$version.0</FileVersion>"
        Set-Content $cliCsprojPath $cliContent

        # Update MCP Server configuration
        $serverJsonPath = "src/ExcelMcp.McpServer/.mcp/server.json"
        $serverContent = Get-Content $serverJsonPath -Raw

        # Update main version field (near top of file, not in _meta section)
        $serverContent = $serverContent -replace '(\s*"version":\s*)"[\d\.]+"(\s*,\s*\n\s*"title")' , "`$1`"$version`"`$2"

        # Update package version in packages array (specifically after identifier field)
        $serverContent = $serverContent -replace '("identifier":\s*"Sbroenne\.ExcelMcp\.McpServer",\s*\n\s*"version":\s*)"[\d\.]+"', "`$1`"$version`""

        Set-Content $serverJsonPath $serverContent

        Write-Output "‚úÖ Updated MCP Server project and configuration to $version"
        Write-Output "‚úÖ Updated CLI project to $version"

        # Set environment variable for later steps
        echo "PACKAGE_VERSION=$version" >> $env:GITHUB_ENV
      shell: pwsh

    - name: Restore dependencies
      run: |
        dotnet restore src/ExcelMcp.McpServer/ExcelMcp.McpServer.csproj
        dotnet restore src/ExcelMcp.CLI/ExcelMcp.CLI.csproj

    - name: Build MCP Server & CLI
      run: |
        dotnet build src/ExcelMcp.McpServer/ExcelMcp.McpServer.csproj --configuration Release --no-restore
        dotnet build src/ExcelMcp.CLI/ExcelMcp.CLI.csproj --configuration Release --no-restore
      env:
        # Application Insights connection string is embedded at build time by MSBuild
        # See ExcelMcp.McpServer.csproj for the GenerateTelemetryConfig target
        APPINSIGHTS_CONNECTION_STRING: ${{ secrets.APPINSIGHTS_CONNECTION_STRING }}

    - name: Skip Tests (require Excel)
      run: |
        Write-Output "‚ÑπÔ∏è Note: Tests skipped in CI - they require Microsoft Excel"
        Write-Output "   All tests are Integration tests that need Excel COM interop"
        Write-Output "   Run tests locally with Excel installed or on Azure self-hosted runner"
      shell: pwsh

    - name: Pack NuGet Packages
      run: |
        dotnet pack src/ExcelMcp.McpServer/ExcelMcp.McpServer.csproj --configuration Release --no-build --output ./nupkg
        dotnet pack src/ExcelMcp.CLI/ExcelMcp.CLI.csproj --configuration Release --no-build --output ./nupkg

    - name: NuGet login (OIDC ‚Üí temp API key)
      uses: NuGet/login@v1
      id: nuget-login
      with:
        user: ${{ secrets.NUGET_USER }}  # Your nuget.org username (profile name), NOT email

    - name: Publish MCP Server to NuGet.org
      run: |
        $version = $env:PACKAGE_VERSION
        $packagePath = "nupkg/Sbroenne.ExcelMcp.McpServer.$version.nupkg"

        Write-Output "Publishing $packagePath to NuGet.org using Trusted Publishing (OIDC)..."

        dotnet nuget push $packagePath `
          --api-key ${{ steps.nuget-login.outputs.NUGET_API_KEY }} `
          --source https://api.nuget.org/v3/index.json `
          --skip-duplicate

        Write-Output "üöÄ Published Sbroenne.ExcelMcp.McpServer.$version to NuGet.org"
        Write-Output "üîó Package: https://www.nuget.org/packages/Sbroenne.ExcelMcp.McpServer/$version"
      shell: pwsh

    - name: Publish CLI to NuGet.org
      run: |
        $version = $env:PACKAGE_VERSION
        $packagePath = "nupkg/Sbroenne.ExcelMcp.CLI.$version.nupkg"

        Write-Output "Publishing $packagePath to NuGet.org using Trusted Publishing (OIDC)..."

        dotnet nuget push $packagePath `
          --api-key ${{ steps.nuget-login.outputs.NUGET_API_KEY }} `
          --source https://api.nuget.org/v3/index.json `
          --skip-duplicate

        Write-Output "üöÄ Published Sbroenne.ExcelMcp.CLI.$version to NuGet.org"
        Write-Output "üîó Package: https://www.nuget.org/packages/Sbroenne.ExcelMcp.CLI/$version"
      shell: pwsh

    - name: Wait for NuGet Package Propagation
      run: |
        $version = $env:PACKAGE_VERSION
        $packageId = "sbroenne.excelmcp.mcpserver"
        $readmeUrl = "https://api.nuget.org/v3-flatcontainer/$packageId/$version/readme"

        Write-Output "Waiting for NuGet CDN to propagate package README..."
        Write-Output "Checking: $readmeUrl"

        $maxAttempts = 3  # 3 attempts * 10 minutes = 30 minutes max (safe margin for NuGet propagation)
        $pollIntervalSeconds = 600  # 10 minutes between polls
        $attempt = 0
        $found = $false

        while ($attempt -lt $maxAttempts -and -not $found) {
          $attempt++
          Write-Output "Attempt $attempt of $maxAttempts..."

          try {
            $response = Invoke-WebRequest -Uri $readmeUrl -UseBasicParsing -ErrorAction SilentlyContinue
            if ($response.StatusCode -eq 200) {
              $content = $response.Content
              if ($content -match "mcp-name:\s+io\.github\.sbroenne/mcp-server-excel") {
                Write-Output "‚úÖ README found and contains mcp-name validation string!"
                $found = $true
              } else {
                Write-Output "‚ö†Ô∏è README found but mcp-name string not detected yet"
              }
            }
          } catch {
            Write-Output "README not yet available (expected during propagation)"
          }

          if (-not $found -and $attempt -lt $maxAttempts) {
            Write-Output "Waiting $pollIntervalSeconds seconds (10 minutes) before next check..."
            Start-Sleep -Seconds $pollIntervalSeconds
          }
        }

        if ($found) {
          Write-Output "‚úÖ NuGet package README is propagated and ready for MCP Registry validation"
        } else {
          Write-Output "‚ö†Ô∏è README propagation taking longer than expected, but continuing..."
          Write-Output "   MCP Registry publish may need to be retried manually if validation fails"
        }
      shell: pwsh
      env:
        PACKAGE_VERSION: ${{ env.PACKAGE_VERSION }}

    - name: Install MCP Publisher
      id: install-mcp-publisher
      run: |
        Write-Output "Installing MCP Publisher CLI..."
        $arch = if ([System.Runtime.InteropServices.RuntimeInformation]::ProcessArchitecture -eq "Arm64") { "arm64" } else { "amd64" }
        Invoke-WebRequest -Uri "https://github.com/modelcontextprotocol/registry/releases/latest/download/mcp-publisher_windows_$arch.tar.gz" -OutFile "mcp-publisher.tar.gz"
        tar xf mcp-publisher.tar.gz mcp-publisher.exe
        Remove-Item mcp-publisher.tar.gz
        Write-Output "‚úì MCP Publisher installed"
      shell: pwsh

    - name: Login to MCP Registry
      id: login-mcp-registry
      run: |
        Write-Output "Authenticating with MCP Registry using GitHub OIDC..."
        ./mcp-publisher.exe login github-oidc
        Write-Output "‚úì Authenticated with MCP Registry"
      shell: pwsh

    - name: Publish to MCP Registry
      id: publish-mcp-registry
      run: |
        $version = $env:PACKAGE_VERSION
        $packageId = "sbroenne.excelmcp.mcpserver"

        Write-Output "Publishing to MCP Registry..."
        Write-Output "Server name: io.github.sbroenne/mcp-server-excel"
        Write-Output "Package ID: $packageId"
        Write-Output "Version: $version"
        Write-Output ""

        # Verify README is accessible before publishing
        $readmeUrl = "https://api.nuget.org/v3-flatcontainer/$packageId/$version/readme"
        Write-Output "Pre-publish verification:"
        Write-Output "Checking README at: $readmeUrl"

        try {
          $readmeContent = Invoke-WebRequest -Uri $readmeUrl -UseBasicParsing | Select-Object -ExpandProperty Content
          if ($readmeContent -match "mcp-name:\s+io\.github\.sbroenne/mcp-server-excel") {
            Write-Output "‚úÖ README contains mcp-name validation string"
          } else {
            Write-Output "‚ö†Ô∏è README found but mcp-name string not detected - publishing may fail validation"
          }
        } catch {
          Write-Output "‚ö†Ô∏è Could not verify README accessibility - publishing may fail validation"
        }

        Write-Output ""

        # Check if version already exists in MCP Registry
        Write-Output "Checking if version $version already exists in MCP Registry..."
        $registryCheckUrl = "https://registry.modelcontextprotocol.io/servers/io.github.sbroenne/mcp-server-excel"
        try {
          $registryData = Invoke-RestMethod -Uri $registryCheckUrl -ErrorAction SilentlyContinue
          $existingVersions = $registryData.versions | Select-Object -ExpandProperty version
          if ($existingVersions -contains $version) {
            Write-Output "‚ö†Ô∏è WARNING: Version $version already exists in MCP Registry"
            Write-Output "   Existing versions: $($existingVersions -join ', ')"
            Write-Output "   This publish attempt will likely fail with 'duplicate version' error"
            Write-Output "   If you need to republish, you must either:"
            Write-Output "   1. Use a new version number (recommended), or"
            Write-Output "   2. Contact MCP Registry support to remove the existing version"
            Write-Output ""
          } else {
            Write-Output "‚úÖ Version $version not found in registry - proceeding with publish"
          }
        } catch {
          Write-Output "‚ö†Ô∏è Could not check registry for existing version (this is OK - will attempt publish)"
        }

        Write-Output ""
        Write-Output "Proceeding with MCP Registry publish..."

        # Navigate to MCP Server .mcp directory (where server.json is located)
        Set-Location src/ExcelMcp.McpServer/.mcp

        # Publish to registry (verbose mode for debugging)
        # Capture output and check for errors
        $publishOutput = ../../../mcp-publisher.exe publish --verbose 2>&1
        $publishExitCode = $LASTEXITCODE

        Write-Output $publishOutput

        if ($publishExitCode -eq 0) {
          Write-Output ""
          Write-Output "üöÄ Published to MCP Registry"
          Write-Output "üîó Server available at: https://registry.modelcontextprotocol.io/servers/io.github.sbroenne/mcp-server-excel"
        } else {
          Write-Output ""
          Write-Output "‚ùå MCP Registry publishing failed with exit code $publishExitCode"
          Write-Output "Error details shown above"

          # Check if this is a duplicate version error (acceptable for re-runs)
          if ($publishOutput -match "duplicate version") {
            Write-Output ""
            Write-Output "üîç DUPLICATE VERSION DETECTED - This is OK for re-runs"
            Write-Output "   This version ($version) is already registered in the MCP Registry."
            Write-Output "   The version was successfully published in a previous run."
            Write-Output ""
            Write-Output "‚úÖ Treating as success (version already exists in registry)"
            exit 0  # Exit successfully - duplicate is acceptable
          }

          # Any other error should fail the workflow
          Write-Output ""
          Write-Output "‚ùå MCP Registry publishing failed - this is a real error!"
          Write-Output "   Check the error details above for the root cause."
          exit $publishExitCode
        }
      shell: pwsh
      env:
        PACKAGE_VERSION: ${{ env.PACKAGE_VERSION }}

    - name: MCP Registry Status
      if: always()
      run: |
        Write-Output "========================================"
        Write-Output "MCP Registry Publishing Status Summary"
        Write-Output "========================================"

        $installStatus = "${{ steps.install-mcp-publisher.outcome }}"
        $loginStatus = "${{ steps.login-mcp-registry.outcome }}"
        $publishStatus = "${{ steps.publish-mcp-registry.outcome }}"

        Write-Output "Install MCP Publisher: $installStatus"
        Write-Output "Login to MCP Registry: $loginStatus"
        Write-Output "Publish to MCP Registry: $publishStatus"
        Write-Output ""

        if ($publishStatus -eq "success") {
          Write-Output "‚úÖ MCP Registry publishing succeeded!"
          Write-Output "üîó Server available at: https://registry.modelcontextprotocol.io/servers/io.github.sbroenne/mcp-server-excel"
        } else {
          Write-Output "‚ùå MCP Registry publishing failed"
          Write-Output ""
          Write-Output "   Common reasons for failure:"
          Write-Output "   - Duplicate version: Version already published to MCP Registry"
          Write-Output "   - README validation: NuGet CDN propagation delay or missing mcp-name"
          Write-Output "   - Authentication: GitHub OIDC token issues"
          Write-Output ""
          Write-Output "   ‚úÖ NuGet package publication was SUCCESSFUL"
          Write-Output "   üîó NuGet: https://www.nuget.org/packages/Sbroenne.ExcelMcp.McpServer"
          Write-Output ""
          Write-Output "   To diagnose the issue:"
          Write-Output "   1. Check the 'Publish to MCP Registry' step logs above for specific error messages"
          Write-Output "   2. For duplicate version errors, check: https://registry.modelcontextprotocol.io/servers/io.github.sbroenne/mcp-server-excel"
          Write-Output "   3. For README validation errors, verify: https://api.nuget.org/v3-flatcontainer/sbroenne.excelmcp.mcpserver/${{ env.PACKAGE_VERSION }}/readme"
          Write-Output ""
          Write-Output "   For manual retry, see: docs/MCP_REGISTRY_PUBLISHING.md"
        }

        Write-Output "========================================"
      shell: pwsh

    - name: Create MCP Server Release Package
      run: |
        $version = $env:PACKAGE_VERSION

        # Create release directory structure
        New-Item -ItemType Directory -Path "release" -Force
        New-Item -ItemType Directory -Path "release/ExcelMcp-MCP-Server-$version" -Force

        # Copy MCP Server files
        Copy-Item "src/ExcelMcp.McpServer/bin/Release/net8.0/*" "release/ExcelMcp-MCP-Server-$version/" -Recurse

        # Copy documentation
        Copy-Item "README.md" "release/ExcelMcp-MCP-Server-$version/"
        Copy-Item "LICENSE" "release/ExcelMcp-MCP-Server-$version/"
        Copy-Item "src/ExcelMcp.McpServer/README.md" "release/ExcelMcp-MCP-Server-$version/MCP-SERVER-README.md"

        # Create installation README with proper content
        $readmeContent = "# ExcelMcp MCP Server v$version`n`n"
        $readmeContent += "## Quick Start`n`n"
        $readmeContent += "### Option 1: Install as .NET Tool (Recommended)`n"
        $readmeContent += "``````powershell`n"
        $readmeContent += "# Install globally`n"
        $readmeContent += "dotnet tool install --global Sbroenne.ExcelMcp.McpServer --version $version`n`n"
        $readmeContent += "# Run MCP server`n"
        $readmeContent += "mcp-excel`n`n"
        $readmeContent += "# Update`n"
        $readmeContent += "dotnet tool update --global Sbroenne.ExcelMcp.McpServer`n"
        $readmeContent += "``````n`n"
        $readmeContent += "### Option 2: Run from Binary`n"
        $readmeContent += "``````powershell`n"
        $readmeContent += "dotnet ExcelMcp.McpServer.dll`n"
        $readmeContent += "``````n`n"
        $readmeContent += "## Features`n`n"
        $readmeContent += "- AI Assistant Integration - Native MCP protocol support`n"
        $readmeContent += "- Conversational Interface - Natural language Excel operations`n"
        $readmeContent += "- 12 Resource-Based Tools - Structured API for AI assistants`n"
        $readmeContent += "- Excel Development Focus - Power Query, VBA, Data Model, tables, ranges, worksheets`n`n"
        $readmeContent += "## Requirements`n`n"
        $readmeContent += "- Windows OS with Microsoft Excel installed`n"
        $readmeContent += "- .NET 8.0 runtime`n"
        $readmeContent += "- Excel 2016+ (for COM interop)`n`n"
        $readmeContent += "## License`n`n"
        $readmeContent += "MIT License - see LICENSE file for details.`n"

        Set-Content "release/ExcelMcp-MCP-Server-$version/README.md" $readmeContent

        # Create ZIP
        Compress-Archive -Path "release/ExcelMcp-MCP-Server-$version/*" -DestinationPath "ExcelMcp-MCP-Server-$version-windows.zip"

        Write-Output "Created ExcelMcp-MCP-Server-$version-windows.zip"
      shell: pwsh

    - name: Create CLI Release Package
      run: |
        $version = $env:PACKAGE_VERSION

        # Create CLI release directory
        New-Item -ItemType Directory -Path "release/ExcelMcp-CLI-$version" -Force

        # Copy CLI files
        Copy-Item "src/ExcelMcp.CLI/bin/Release/net8.0/*" "release/ExcelMcp-CLI-$version/" -Recurse

        # Copy documentation
        Copy-Item "README.md" "release/ExcelMcp-CLI-$version/"
        Copy-Item "LICENSE" "release/ExcelMcp-CLI-$version/"
        Copy-Item "src/ExcelMcp.CLI/README.md" "release/ExcelMcp-CLI-$version/CLI-README.md"

        # Create installation README
        $cliReadme = "# ExcelMcp CLI v$version`n`n"
        $cliReadme += "## Quick Start`n`n"
        $cliReadme += "### Option 1: Install as .NET Tool (Recommended)`n"
        $cliReadme += "``````powershell`n"
        $cliReadme += "# Install globally`n"
        $cliReadme += "dotnet tool install --global Sbroenne.ExcelMcp.CLI --version $version`n`n"
        $cliReadme += "# Run CLI`n"
        $cliReadme += "excelcli --help`n`n"
        $cliReadme += "# Update`n"
        $cliReadme += "dotnet tool update --global Sbroenne.ExcelMcp.CLI`n"
        $cliReadme += "``````n`n"
        $cliReadme += "### Option 2: Run from Binary`n"
        $cliReadme += "``````powershell`n"
        $cliReadme += "dotnet ExcelMcp.CLI.dll --help`n"
        $cliReadme += "``````n`n"
        $cliReadme += "## Requirements`n`n"
        $cliReadme += "- Windows OS with Microsoft Excel installed`n"
        $cliReadme += "- .NET 8.0 runtime`n"
        $cliReadme += "- Excel 2016+ (for COM interop)`n`n"
        $cliReadme += "## License`n`n"
        $cliReadme += "MIT License - see LICENSE file for details.`n"

        Set-Content "release/ExcelMcp-CLI-$version/README.md" $cliReadme

        # Create ZIP
        Compress-Archive -Path "release/ExcelMcp-CLI-$version/*" -DestinationPath "ExcelMcp-CLI-$version-windows.zip"

        Write-Output "Created ExcelMcp-CLI-$version-windows.zip"

        # Create release notes using here-string to preserve markdown formatting
        $tagName = "${{ github.ref_name }}"
        $releaseNotes = @"
## What's New

See [CHANGELOG](https://github.com/sbroenne/mcp-server-excel/blob/main/vscode-extension/CHANGELOG.md) for detailed changes.

## Installation

**MCP Server (.NET Tool)**
```powershell
dotnet tool install --global Sbroenne.ExcelMcp.McpServer --version $version
mcp-excel
```

**CLI (.NET Tool)**
```powershell
dotnet tool install --global Sbroenne.ExcelMcp.CLI --version $version
excelcli --help
```

For complete documentation, see the [main README](https://github.com/sbroenne/mcp-server-excel#readme).

### Requirements
- Windows OS with Microsoft Excel installed
- .NET 8.0 runtime
- Excel 2016+ (for COM interop)

### Documentation
- GitHub Repository: https://github.com/sbroenne/mcp-server-excel
- MCP Server: src/ExcelMcp.McpServer/README.md
- CLI: src/ExcelMcp.CLI/README.md
"@

        # Create the release with both packages
        gh release create "$tagName" `
          "ExcelMcp-MCP-Server-$version-windows.zip" `
          "ExcelMcp-CLI-$version-windows.zip" `
          --title "ExcelMcp v$version - MCP Server & CLI" `
          --notes $releaseNotes
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        PACKAGE_VERSION: ${{ env.PACKAGE_VERSION }}
      shell: pwsh
