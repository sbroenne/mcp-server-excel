# =============================================================================
# Monthly Report Generation - CLI Automation Script Simulation
# =============================================================================
#
# Real-world scenario: A finance analyst needs to generate a monthly financial
# report from scratch using excelcli. Demonstrates programmatic automation with
# CLI including session management, data operations, formatting.
#
# =============================================================================

criteria:
  success_rate: 1

ai_summary:
  enabled: true
  judge_provider: azure-openai-judge

providers:
  - name: azure-openai-gpt41
    type: AZURE
    auth_type: entra_id
    model: gpt-4.1
    baseUrl: "{{AZURE_OPENAI_ENDPOINT}}"
    version: 2025-01-01-preview
  - name: azure-openai-gpt5-chat
    type: AZURE
    auth_type: entra_id
    model: gpt-5.1-chat
    baseUrl: "{{AZURE_OPENAI_ENDPOINT}}"
    version: 2025-01-01-preview
  - name: azure-openai-judge
    type: AZURE
    auth_type: entra_id
    model: gpt-4.1
    baseUrl: "{{AZURE_OPENAI_ENDPOINT}}"
    version: 2025-01-01-preview

servers:
  - name: excel-cli
    type: cli
    command: "{{CLI_COMMAND}}"
    shell: powershell
    working_dir: "{{TEMP_DIR}}"
    tool_prefix: excel

agents:
  - name: gpt41-agent
    servers:
      - name: excel-cli
    provider: azure-openai-gpt41
    skill:
      path: "{{SKILL_PATH_CLI}}"
      file_access: true
    system_prompt: |
      You are an automation engineer using excelcli. Write efficient, idempotent CLI scripts.
      - Always use -q flag for clean JSON output
      - Use --save flag to persist changes
      - Keep sessions open while working on same file
      - Validate data after each operation
      - Provide clear status updates
    clarification_detection:
      enabled: true
      judge_provider: azure-openai-judge

settings:
  verbose: true
  max_iterations: 18


sessions:
  - name: "Monthly Financial Report Automation"
    tests:
      - name: "Build complete financial report with formulas"
        prompt: |
          I need to automate the creation of our monthly financial report. Let me build this from scratch with data, formulas, and formatting.

          STEP 1: Create the report file and structure

          Create {{TEMP_DIR}}/financial-report-jan2025-{{randomValue type='UUID'}}.xlsx
          Open it and create the following structure in Sheet1:

          In A1:B6, create the revenue section:
          Revenue Summary,
          Product Sales, 450000
          Service Revenue, 125000
          Other Income, 18500
          Total Revenue, (formula: =SUM(B2:B4))

          In A8:B12, create the expense section:
          Operating Expenses,
          Salaries, 280000
          Rent, 35000
          Utilities, 12000
          Total Expenses, (formula: =SUM(B9:B11))

          In A14:B15:
          Net Income, (formula: =B6-B12)

          STEP 2: Format the report professionally

          - Make headers (A1, A8, A14) bold
          - Format all currency amounts (B2:B4, B9:B11, B6, B12, B15) as currency (2 decimals)
          - Apply alternating row colors to the expense section
          - Set column widths: A=25, B=15

          STEP 3: Verify calculations

          Read the calculated values:
          - Total Revenue
          - Total Expenses
          - Net Income

          Report all three values to confirm formulas are working.

        assertions:
          - type: no_hallucinated_tools
          - type: no_clarification_questions
          - type: cli_exit_code_equals
            expected: 0
          - type: output_regex
            pattern: "(?i)(450000|revenue|net income|formula)"

      - name: "Add variance analysis and update data"
        prompt: |
          Great! Now add a variance analysis. I need to compare actual vs. budget.

          STEP 1: Add Budget data

          In column D, add Budget column header, then budget figures:
          - Product Sales Budget: 440000
          - Service Revenue Budget: 110000
          - Other Income Budget: 20000
          - Salaries Budget: 290000
          - Rent Budget: 35000
          - Utilities Budget: 15000

          STEP 2: Add Variance formulas

          In column E (labeled "Variance"), add formulas that calculate:
          - Variance = Actual - Budget for each line item
          - For totals, show the variance calculations too

          STEP 3: Update one actual value

          Product Sales actually came in at 455000 (not 450000). Update B2 to reflect this.
          Verify that:
          - The variance in E2 automatically recalculates
          - The Total Revenue in B6 updates automatically
          - The Net Income in B15 updates automatically

          STEP 4: Report final numbers

          Provide:
          - New Total Revenue
          - Product Sales Variance (actual vs. budget)
          - New Net Income
          - Confirm all formulas are still working

        assertions:
          - type: no_hallucinated_tools
          - type: no_clarification_questions
          - type: cli_exit_code_equals
            expected: 0
          - type: output_regex
            pattern: "(?i)(variance|455000|formula|recalculate|updated)"

      - name: "Create summary table and save report"
        prompt: |
          Perfect! Let me create a summary dashboard at the bottom and finalize the report.

          STEP 1: Create Executive Summary Table

          In A17:B22, create a summary table:
          KPI, Value
          Total Revenue, (formula referencing B6)
          Total Expenses, (formula referencing B12)
          Net Income, (formula referencing B15)
          Profit Margin %, (formula: =B20/B18*100, formatted as percentage)
          YoY Growth %, 8.5%

          STEP 2: Format the summary
          - Make the table header (A17:B17) bold with light blue background
          - Format currency cells appropriately
          - Format percentage to 1 decimal place

          STEP 3: Final validation

          Read the used range of the sheet - should show everything is there and formatted.

          Get the Profit Margin % value to verify it calculated correctly:
          Should be approximately: (573500 / 455000 + 125000 + 18500) * 100

          STEP 4: Save the report

          Save the file with all changes.

          Report:
          - Total Revenue amount
          - Net Income amount
          - Profit Margin percentage
          - Confirmation file was saved

        assertions:
          - type: no_hallucinated_tools
          - type: no_clarification_questions
          - type: cli_exit_code_equals
            expected: 0
          - type: output_regex
            pattern: "(?i)(summary|margin|saved|598500|complete)"
