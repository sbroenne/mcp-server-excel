# =============================================================================
# Excel Slicer Test - excel_slicer Tool
# =============================================================================
#
# Tests: excel_slicer tool for PivotTable AND Table slicer operations
#
# Tools Covered:
#   - excel_slicer with actions:
#     PivotTable Slicers:
#       - CreateSlicer: Create slicer for PivotTable field
#       - ListSlicers: List all PivotTable slicers
#       - SetSlicerSelection: Filter PivotTable via slicer
#       - DeleteSlicer: Remove PivotTable slicer
#     Table Slicers:
#       - CreateTableSlicer: Create slicer for Table column
#       - ListTableSlicers: List all Table slicers
#       - SetTableSlicerSelection: Filter Table via slicer
#       - DeleteTableSlicer: Remove Table slicer
#
# Key Validation:
#   - LLM creates slicers for interactive filtering
#   - LLM understands difference between PivotTable and Table slicers
#   - LLM uses slicers to filter data dynamically
#
# Prerequisites:
#   - Windows 10/11 with Excel installed
#   - Excel MCP Server
#   - Environment: AZURE_OPENAI_ENDPOINT
#
# =============================================================================

criteria:
  success_rate: 1  # 100% required

providers:
  - name: azure-openai-gpt41
    type: AZURE
    auth_type: entra_id
    model: gpt-4.1
    baseUrl: "{{AZURE_OPENAI_ENDPOINT}}"
    version: 2025-01-01-preview
    retry:
      retry_on_429: true
      max_retries: 5
  - name: azure-openai-gpt52-chat
    type: AZURE
    auth_type: entra_id
    model: gpt-5.2-chat
    baseUrl: "{{AZURE_OPENAI_ENDPOINT}}"
    version: 2025-01-01-preview
    retry:
      retry_on_429: true
      max_retries: 5
  # Provider for clarification detection judge
  - name: azure-openai-judge
    type: AZURE
    auth_type: entra_id
    model: gpt-5.2-chat
    baseUrl: "{{AZURE_OPENAI_ENDPOINT}}"
    version: 2025-01-01-preview

servers:
  - name: excel-mcp
    type: stdio
    command: "{{SERVER_COMMAND}}"
    server_delay: 30s

agents:
  - name: gpt41-agent
    servers:
      - name: excel-mcp
    provider: azure-openai-gpt41
    system_prompt: |
      You are {{AGENT_NAME}}, an Excel automation agent using {{PROVIDER_NAME}}.

      RULES:
      - Execute tasks immediately without asking for confirmation
      - Never ask clarifying questions - make reasonable assumptions and proceed
      - Never show Excel to the user - keep it hidden
      - Report results after completion
    clarification_detection:
      enabled: true
      judge_provider: azure-openai-judge
  - name: gpt52-chat-agent
    servers:
      - name: excel-mcp
    provider: azure-openai-gpt52-chat
    system_prompt: |
      You are {{AGENT_NAME}}, an Excel automation agent using {{PROVIDER_NAME}}.

      RULES:
      - Execute tasks immediately without asking for confirmation
      - Never ask clarifying questions - make reasonable assumptions and proceed
      - Never show Excel to the user - keep it hidden
      - Report results after completion
    clarification_detection:
      enabled: true
      judge_provider: azure-openai-judge

settings:
  verbose: true
  max_iterations: 20


sessions:
  # ==========================================================================
  # Session 1: PivotTable Slicer Workflow
  # ==========================================================================
  - name: "PivotTable Slicer Workflow"
    tests:
      # ----------------------------------------------------------------------
      # Step 1: Create workbook with data and PivotTable
      # ----------------------------------------------------------------------
      - name: "Setup PivotTable for slicer test"
        prompt: |
          I want to test PivotTable slicers. Let's set up the data first.

          Create a new Excel file at {{TEST_RESULTS_PATH}}/pivottable-slicer-{{randomValue type='UUID'}}.xlsx

          On Sheet1, enter this sales data starting at A1:

          Region, Product, Quarter, Sales
          North, Laptop, Q1, 15000
          North, Phone, Q1, 8000
          North, Laptop, Q2, 18000
          North, Phone, Q2, 9500
          South, Laptop, Q1, 12000
          South, Phone, Q1, 7500
          South, Laptop, Q2, 14000
          South, Phone, Q2, 8200

          Convert this to a table called "SalesData".

          Then create a PivotTable on a new sheet called "Analysis" that shows:
          - Region as rows
          - Sum of Sales as values
        assertions:
          - type: no_hallucinated_tools
          - type: no_clarification_questions
          - type: tool_called
            tool: excel_table
          - type: tool_called
            tool: excel_pivottable
          - type: output_regex
            pattern: "(?i)(pivot|region|sales|created)"

      # ----------------------------------------------------------------------
      # Step 2: Create slicer for Region field
      # ----------------------------------------------------------------------
      - name: "Create Region slicer"
        prompt: |
          Now I want to filter this PivotTable interactively.

          Create a slicer for the Region field on the PivotTable we just made.
          Position it at cell E2.

          After creating, list all slicers to confirm it was created.
        assertions:
          - type: no_hallucinated_tools
          - type: no_clarification_questions
          - type: tool_called
            tool: excel_slicer
          - type: output_regex
            pattern: "(?i)(slicer|region|created|success)"

      # ----------------------------------------------------------------------
      # Step 3: Filter using the slicer
      # ----------------------------------------------------------------------
      - name: "Filter PivotTable using slicer"
        prompt: |
          Great! Now use the Region slicer to show only "North" region data.

          After applying the filter, what does the PivotTable show for total North sales?
        assertions:
          - type: no_hallucinated_tools
          - type: no_clarification_questions
          - type: tool_called
            tool: excel_slicer
          - type: output_regex
            pattern: "(?i)(north|filter|slicer|50500|sales)"

      # ----------------------------------------------------------------------
      # Step 4: Clear filter and add another slicer
      # ----------------------------------------------------------------------
      - name: "Add Product slicer"
        prompt: |
          Now create a second slicer for the Product field, positioned at cell G2.

          Then clear the Region filter so all regions show again.

          How many slicers do we have now?
        assertions:
          - type: no_hallucinated_tools
          - type: no_clarification_questions
          - type: tool_called
            tool: excel_slicer
          - type: output_regex
            pattern: "(?i)(slicer|product|2|two|created)"

      # ----------------------------------------------------------------------
      # Step 5: Delete slicers and close
      # ----------------------------------------------------------------------
      - name: "Delete slicers and close"
        prompt: |
          Delete both slicers we created.

          Save and close the file.

          Confirm both slicers were removed.
        assertions:
          - type: no_hallucinated_tools
          - type: no_clarification_questions
          - type: tool_called
            tool: excel_slicer
          - type: tool_called
            tool: excel_file
          - type: output_regex
            pattern: "(?i)(delete|removed|closed|saved|success)"


  # ==========================================================================
  # Session 2: Table Slicer Workflow
  # ==========================================================================
  - name: "Table Slicer Workflow"
    tests:
      # ----------------------------------------------------------------------
      # Step 1: Create workbook with Table
      # ----------------------------------------------------------------------
      - name: "Setup Table for slicer test"
        prompt: |
          I want to test Table slicers (different from PivotTable slicers).

          Create a new Excel file at {{TEST_RESULTS_PATH}}/table-slicer-{{randomValue type='UUID'}}.xlsx

          On Sheet1, enter this employee data starting at A1:

          Department, Employee, Status, Salary
          Engineering, Alice, Active, 85000
          Engineering, Bob, Active, 92000
          Marketing, Carol, Active, 78000
          Marketing, Dave, Inactive, 70000
          Sales, Eve, Active, 65000
          Sales, Frank, Inactive, 62000
          Engineering, Grace, Active, 88000
          Sales, Henry, Active, 71000

          Convert this to an Excel table called "Employees".
        assertions:
          - type: no_hallucinated_tools
          - type: no_clarification_questions
          - type: tool_called
            tool: excel_table
          - type: output_regex
            pattern: "(?i)(employees|table|created|success)"

      # ----------------------------------------------------------------------
      # Step 2: Create Table slicer for Department
      # ----------------------------------------------------------------------
      - name: "Create Department slicer on Table"
        prompt: |
          Now create a Table slicer for the Department column.
          Position it at cell F2.

          List all Table slicers to confirm it was created.
        assertions:
          - type: no_hallucinated_tools
          - type: no_clarification_questions
          - type: tool_called
            tool: excel_slicer
          - type: output_regex
            pattern: "(?i)(slicer|department|table|created|success)"

      # ----------------------------------------------------------------------
      # Step 3: Filter Table using slicer
      # ----------------------------------------------------------------------
      - name: "Filter Table to Engineering only"
        prompt: |
          Use the Department slicer to filter the table to show only Engineering employees.

          How many Engineering employees are there?
        assertions:
          - type: no_hallucinated_tools
          - type: no_clarification_questions
          - type: tool_called
            tool: excel_slicer
          - type: output_regex
            pattern: "(?i)(engineering|3|three|filter|alice|bob|grace)"

      # ----------------------------------------------------------------------
      # Step 4: Create second slicer and multi-select
      # ----------------------------------------------------------------------
      - name: "Add Status slicer and filter"
        prompt: |
          Add another Table slicer for the Status column at cell H2.

          Then filter to show only "Active" employees across all departments.

          How many active employees are there total?
        assertions:
          - type: no_hallucinated_tools
          - type: no_clarification_questions
          - type: tool_called
            tool: excel_slicer
          - type: output_regex
            pattern: "(?i)(status|active|6|six|slicer)"

      # ----------------------------------------------------------------------
      # Step 5: Cleanup and close
      # ----------------------------------------------------------------------
      - name: "Delete Table slicers and close"
        prompt: |
          Delete all the Table slicers we created.

          Save and close the file.

          Summarize: what's the difference between Table slicers and PivotTable slicers?
        assertions:
          - type: no_hallucinated_tools
          - type: no_clarification_questions
          - type: tool_called
            tool: excel_slicer
          - type: tool_called
            tool: excel_file
          - type: output_regex
            pattern: "(?i)(delete|table|pivot|different|closed|saved)"


  # ==========================================================================
  # Session 3: Combined Slicer Workflow (Both Types)
  # ==========================================================================
  - name: "Combined Table and PivotTable Slicers"
    tests:
      # ----------------------------------------------------------------------
      # Step 1: Create comprehensive data with both Table and PivotTable
      # ----------------------------------------------------------------------
      - name: "Setup workbook with Table and PivotTable"
        prompt: |
          Create a new Excel file at {{TEST_RESULTS_PATH}}/combined-slicer-{{randomValue type='UUID'}}.xlsx

          On Sheet1, enter this inventory data starting at A1:

          Category, Product, Warehouse, Stock, Price
          Electronics, Laptop, West, 50, 999
          Electronics, Phone, West, 120, 599
          Electronics, Laptop, East, 35, 999
          Electronics, Phone, East, 80, 599
          Furniture, Desk, West, 25, 350
          Furniture, Chair, West, 40, 175
          Furniture, Desk, East, 30, 350
          Furniture, Chair, East, 55, 175

          1. Convert this to a table called "Inventory"
          2. Create a PivotTable on a new sheet called "Summary" that shows:
             - Category as rows
             - Sum of Stock as values
        assertions:
          - type: no_hallucinated_tools
          - type: no_clarification_questions
          - type: tool_called
            tool: excel_table
          - type: tool_called
            tool: excel_pivottable
          - type: output_regex
            pattern: "(?i)(inventory|pivot|category|stock|created)"

      # ----------------------------------------------------------------------
      # Step 2: Create both types of slicers
      # ----------------------------------------------------------------------
      - name: "Create Table and PivotTable slicers"
        prompt: |
          I want to create slicers for both the Table and the PivotTable.

          1. On Sheet1, create a TABLE slicer for the Warehouse column at F2
          2. On the Summary sheet, create a PIVOTTABLE slicer for the Category field at D2

          List all slicers of each type to confirm both were created.
        assertions:
          - type: no_hallucinated_tools
          - type: no_clarification_questions
          - type: tool_called
            tool: excel_slicer
          - type: output_regex
            pattern: "(?i)(warehouse|category|slicer|table|pivot|created)"

      # ----------------------------------------------------------------------
      # Step 3: Use both slicers to filter
      # ----------------------------------------------------------------------
      - name: "Filter using both slicer types"
        prompt: |
          Now let's use both slicers:

          1. Use the Table slicer to filter the Inventory table to show only "West" warehouse
          2. Use the PivotTable slicer to filter the Summary to show only "Electronics"

          How much Electronics stock is in the West warehouse?
        assertions:
          - type: no_hallucinated_tools
          - type: no_clarification_questions
          - type: tool_called
            tool: excel_slicer
          - type: output_regex
            pattern: "(?i)(west|electronics|170|filter|stock)"

      # ----------------------------------------------------------------------
      # Step 4: Clear and verify
      # ----------------------------------------------------------------------
      - name: "Clear filters and close"
        prompt: |
          Clear all slicer filters so all data shows again.

          Save and close the file.

          How many total slicers did we create (both Table and PivotTable)?
        assertions:
          - type: no_hallucinated_tools
          - type: no_clarification_questions
          - type: tool_called
            tool: excel_slicer
          - type: tool_called
            tool: excel_file
          - type: output_regex
            pattern: "(?i)(2|two|clear|saved|closed|success)"
