# =============================================================================
# Chart Create-From-Table Test - Validates LLM Uses create-from-table Action
# =============================================================================
#
# Purpose: Validates that LLMs can correctly use the create-from-table action
# to create charts directly from Excel Tables, rather than using create-from-range.
#
# Background: The create-from-table action simplifies chart creation when data
# is already in an Excel Table format. This test validates:
#   - LLM creates an Excel Table first
#   - LLM uses create-from-table (not create-from-range) for table data
#   - Chart is positioned correctly without overlapping the table
#
# Prerequisites:
#   - Windows 10/11 with Excel installed
#   - Excel MCP Server
#   - Environment: AZURE_OPENAI_ENDPOINT
#
# =============================================================================

criteria:
  success_rate: 1  # 100% required

ai_summary:
  enabled: true
  judge_provider: azure-openai-judge

providers:
  - name: azure-openai-gpt41
    type: AZURE
    auth_type: entra_id
    model: gpt-4.1
    baseUrl: "{{AZURE_OPENAI_ENDPOINT}}"
    version: 2025-01-01-preview
    retry:
      retry_on_429: true
      max_retries: 5
  - name: azure-openai-judge
    type: AZURE
    auth_type: entra_id
    model: gpt-4.1
    baseUrl: "{{AZURE_OPENAI_ENDPOINT}}"
    version: 2025-01-01-preview
    retry:
      retry_on_429: true
      max_retries: 5

servers:
  - name: excel-mcp
    type: stdio
    command: "{{SERVER_COMMAND}}"
    server_delay: 30s

agents:
  - name: gpt41-agent
    servers:
      - name: excel-mcp
        # Only include tools needed for chart-from-table tests
        allowed_tools:
          - excel_file
          - excel_range
          - excel_table
          - excel_chart
    provider: azure-openai-gpt41
    # Agent Skills: Load excel-mcp skill for server-specific guidance
    skill:
      path: "{{SKILL_PATH_MCP}}"
      file_access: true
    clarification_detection:
      enabled: true
      judge_provider: azure-openai-judge

settings:
  verbose: true
  max_iterations: 15


sessions:
  # ==========================================================================
  # Session 1: Create Chart From Table - Basic
  # Tests that LLM uses create-from-table action for Excel Table data
  # ==========================================================================
  - name: "Chart From Table Basic"
    tests:
      - name: "Create column chart from Excel Table using create-from-table"
        prompt: |
          1. Create a new empty Excel file at {{TEMP_DIR}}/llm-test-chart-from-table-{{randomValue type='UUID'}}.xlsx and open it
          2. Put sales data in A1:C5 on Sheet1:
             Row 1: Product, Q1 Sales, Q2 Sales
             Row 2: Laptop, 45000, 52000
             Row 3: Phone, 38000, 41000
             Row 4: Tablet, 22000, 28000
             Row 5: Monitor, 15000, 18000
          3. Convert A1:C5 into an Excel Table named "SalesData"
          4. Create a column chart from the SalesData table using the create-from-table action
          5. Position the chart below the table (use targetRange like 'A8:F20' or appropriate coordinates)
          6. Read the chart info and report: chart name, chart type, and position
          7. Save and close the file
        assertions:
          - type: no_hallucinated_tools
          - type: no_rate_limit_errors
          - type: no_clarification_questions
          - type: tool_called
            tool: excel_file
          - type: tool_called
            tool: excel_table
          - type: tool_called
            tool: excel_chart
          # Verify table was created
          - type: output_regex
            pattern: "(?i)(salesdata|table.*created)"
          # Verify chart was created
          - type: output_regex
            pattern: "(?i)(chart|created|column)"

  # ==========================================================================
  # Session 2: Create Chart From Table - Different Chart Types
  # Tests that LLM can create various chart types from tables
  # ==========================================================================
  - name: "Chart From Table Types"
    tests:
      - name: "Create pie chart from Excel Table"
        prompt: |
          1. Create a new empty Excel file at {{TEMP_DIR}}/llm-test-pie-from-table-{{randomValue type='UUID'}}.xlsx and open it
          2. Put market share data in A1:B5 on Sheet1:
             Row 1: Company, Market Share
             Row 2: Alpha Corp, 35
             Row 3: Beta Inc, 28
             Row 4: Gamma LLC, 22
             Row 5: Delta Co, 15
          3. Convert A1:B5 into an Excel Table named "MarketShare"
          4. Create a PIE chart from the MarketShare table using the create-from-table action
          5. Position the chart to the right of the table (targetRange='D2:I15' or similar)
          6. Report the chart name and type
          7. Save and close the file
        assertions:
          - type: no_hallucinated_tools
          - type: no_rate_limit_errors
          - type: no_clarification_questions
          - type: tool_called
            tool: excel_file
          - type: tool_called
            tool: excel_table
          - type: tool_called
            tool: excel_chart
          # Verify table exists
          - type: output_regex
            pattern: "(?i)(marketshare|table)"
          # Verify pie chart created
          - type: output_regex
            pattern: "(?i)(pie|chart)"

  # ==========================================================================
  # Session 3: Create Chart From Table - Multiple Charts
  # Tests that LLM can create multiple charts from the same table
  # ==========================================================================
  - name: "Multiple Charts From Table"
    tests:
      - name: "Create line and bar charts from same table"
        prompt: |
          1. Create a new empty Excel file at {{TEMP_DIR}}/llm-test-multi-chart-table-{{randomValue type='UUID'}}.xlsx and open it
          2. Put monthly data in A1:D7 on Sheet1:
             Row 1: Month, Revenue, Expenses, Profit
             Row 2: Jan, 100000, 75000, 25000
             Row 3: Feb, 110000, 78000, 32000
             Row 4: Mar, 95000, 72000, 23000
             Row 5: Apr, 120000, 82000, 38000
             Row 6: May, 115000, 80000, 35000
             Row 7: Jun, 130000, 85000, 45000
          3. Convert A1:D7 into an Excel Table named "FinancialData"
          4. Create a LINE chart from the FinancialData table using create-from-table, position it at targetRange='F2:L12'
          5. Create a BAR chart from the same FinancialData table using create-from-table, position it at targetRange='F14:L24'
          6. List all charts and report their names and types
          7. Save and close the file
        assertions:
          - type: no_hallucinated_tools
          - type: no_rate_limit_errors
          - type: no_clarification_questions
          - type: tool_called
            tool: excel_file
          - type: tool_called
            tool: excel_table
          - type: tool_called
            tool: excel_chart
          # Verify table created
          - type: output_regex
            pattern: "(?i)(financialdata|table)"
          # Verify multiple charts
          - type: output_regex
            pattern: "(?i)(line|bar)"
          # Verify 2 charts mentioned
          - type: output_regex
            pattern: "(?i)(2 chart|two chart|chart.*chart)"
