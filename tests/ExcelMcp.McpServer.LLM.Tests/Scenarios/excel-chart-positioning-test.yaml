# =============================================================================
# Chart Positioning Test - Validates LLM Avoids Overlapping Data
# =============================================================================
#
# Purpose: Validates that LLMs properly position charts to avoid overlapping
# with existing data, tables, and other content.
#
# Background: Common LLM mistake is placing charts at default position (0,0)
# which overlaps with source data. This test validates:
#   - LLM checks used range before positioning
#   - Charts are placed in empty areas (below or right of data)
#   - FitToRange is used when appropriate
#
# Prerequisites:
#   - Windows 10/11 with Excel installed
#   - Excel MCP Server
#   - Environment: AZURE_OPENAI_ENDPOINT
#
# =============================================================================

criteria:
  success_rate: 1  # 100% required

ai_summary:
  enabled: true
  judge_provider: azure-openai-judge

providers:
  - name: azure-openai-gpt41
    type: AZURE
    auth_type: entra_id
    model: gpt-4.1
    baseUrl: "{{AZURE_OPENAI_ENDPOINT}}"
    version: 2025-01-01-preview
  - name: azure-openai-gpt5-chat
    type: AZURE
    auth_type: entra_id
    model: gpt-5.2-chat
    baseUrl: "{{AZURE_OPENAI_ENDPOINT}}"
    version: 2025-01-01-preview
  - name: azure-openai-judge
    type: AZURE
    auth_type: entra_id
    model: gpt-4.1
    baseUrl: "{{AZURE_OPENAI_ENDPOINT}}"
    version: 2025-01-01-preview

servers:
  - name: excel-mcp
    type: stdio
    command: "{{SERVER_COMMAND}}"
    server_delay: 30s

agents:
  - name: gpt41-agent
    servers:
      - name: excel-mcp
    provider: azure-openai-gpt41
    # Agent Skills: Load excel-mcp skill for server-specific guidance
    skill:
      path: "{{SKILL_PATH_MCP}}"
      file_access: true
    clarification_detection:
      enabled: true
      judge_provider: azure-openai-judge
  - name: gpt5-chat-agent
    servers:
      - name: excel-mcp
    provider: azure-openai-gpt5-chat
    # Agent Skills: Load excel-mcp skill for server-specific guidance
    skill:
      path: "{{SKILL_PATH_MCP}}"
      file_access: true
    clarification_detection:
      enabled: true
      judge_provider: azure-openai-judge

settings:
  verbose: true
  max_iterations: 15


sessions:
  # ==========================================================================
  # Session 1: Chart Position Below Data
  # Tests that LLM positions chart below a data table
  # ==========================================================================
  - name: "Chart Below Data"
    tests:
      - name: "Create chart positioned below data table"
        prompt: |
          1. Create a new empty Excel file at {{TEMP_DIR}}/llm-test-chart-pos-{{randomValue type='UUID'}}.xlsx and open it
          2. Put sales data in A1:C6 on Sheet1:
             Row 1: Month, Revenue, Expenses
             Row 2: January, 50000, 35000
             Row 3: February, 55000, 38000
             Row 4: March, 48000, 32000
             Row 5: April, 62000, 41000
             Row 6: May, 58000, 39000
          3. Create a column chart from B1:C6 with Month labels from A1:A6
          4. Position the chart so it does NOT overlap with the data - it should be placed BELOW row 6
          5. Read the chart info and verify the top position is greater than 90 points (row 6 ends around 90 points)
          6. Report the exact chart position (left, top, width, height) and the topLeftCell
          7. Save and close the file (so the result can be inspected)
        assertions:
          - type: no_hallucinated_tools
          - type: no_rate_limit_errors
          - type: no_clarification_questions
          - type: tool_called
            tool: excel_file
          - type: tool_called
            tool: excel_chart
          # Verify chart was created
          - type: output_regex
            pattern: "(?i)(chart|created)"
          # Verify position reported - should show top > 90
          - type: output_regex
            pattern: "(?i)(top|position)"
          # Verify topLeftCell is below row 6 (row 7+)
          - type: output_regex
            pattern: "(?i)(\\$[A-Z]+\\$[7-9]|\\$[A-Z]+\\$[1-9][0-9]|row [7-9]|row 1[0-9])"

  # ==========================================================================
  # Session 2: Chart Position Right of Table
  # Tests that LLM positions chart to the right of an Excel Table
  # ==========================================================================
  - name: "Chart Right of Table"
    tests:
      - name: "Create chart next to Excel Table without overlap"
        prompt: |
          1. Create a new empty Excel file at {{TEMP_DIR}}/llm-test-chart-table-{{randomValue type='UUID'}}.xlsx and open it
          2. Put product data in A1:D5 on Sheet1:
             Row 1: Product, Q1, Q2, Q3
             Row 2: Widget, 100, 150, 120
             Row 3: Gadget, 80, 90, 110
             Row 4: Device, 200, 180, 220
             Row 5: Tool, 50, 60, 75
          3. Convert A1:D5 into an Excel Table named "ProductSales"
          4. Create a line chart from the table's numeric data (columns B:D)
          5. Position the chart to the RIGHT of the table (starting at column F or later) so it doesn't overlap
          6. Read chart info and verify the left position is > 240 points and topLeftCell is in column F or later
          7. Report the exact chart position (left, top) and topLeftCell
          8. Save and close the file (so the result can be inspected)
        assertions:
          - type: no_hallucinated_tools
          - type: no_rate_limit_errors
          - type: no_clarification_questions
          - type: tool_called
            tool: excel_file
          - type: tool_called
            tool: excel_table
          - type: tool_called
            tool: excel_chart
          # Verify chart created
          - type: output_regex
            pattern: "(?i)(chart|created)"
          # Verify table exists
          - type: output_regex
            pattern: "(?i)(productsales|table)"
          # Verify topLeftCell is column F or later
          - type: output_regex
            pattern: "(?i)(\\$[F-Z]+\\$|column [F-Z]|left.*[2-9][0-9]{2})"

  # ==========================================================================
  # Session 3: targetRange Positioning (Direct cell-relative create)
  # Tests that LLM uses targetRange parameter for one-step positioning
  # ==========================================================================
  - name: "targetRange Positioning"
    tests:
      - name: "Create chart with targetRange for direct cell positioning"
        prompt: |
          1. Create a new empty Excel file at {{TEMP_DIR}}/llm-test-targetrange-{{randomValue type='UUID'}}.xlsx and open it
          2. Put quarterly data in A1:E5 on Sheet1:
             Row 1: Region, Q1, Q2, Q3, Q4
             Row 2: North, 1000, 1200, 1100, 1400
             Row 3: South, 800, 900, 950, 1000
             Row 4: East, 1500, 1600, 1450, 1700
             Row 5: West, 600, 700, 650, 800
          3. Create a bar chart from B1:E5 using the targetRange parameter to position it directly within cells G2:L15
             (Use targetRange='G2:L15' in the create-from-range action instead of left/top coordinates)
          4. Read chart info and verify topLeftCell is G2 (or close to it)
          5. Report the exact chart topLeftCell and bottomRightCell
          6. Save and close the file (so the result can be inspected)
        assertions:
          - type: no_hallucinated_tools
          - type: no_rate_limit_errors
          - type: no_clarification_questions
          - type: tool_called
            tool: excel_file
          - type: tool_called
            tool: excel_chart
          # Verify chart created and positioned
          - type: output_regex
            pattern: "(?i)(chart|created|bar)"
          # Verify data preserved
          - type: output_regex
            pattern: "(?i)(north|south|east|west)"
          # Verify topLeftCell is G2 or nearby (targetRange result)
          - type: output_regex
            pattern: "(?i)(\\$G\\$2|G2|topLeftCell.*G)"

  # ==========================================================================
  # Session 4: Multiple Charts No Overlap
  # Tests that LLM positions multiple charts without overlapping each other
  # ==========================================================================
  - name: "Multiple Charts"
    tests:
      - name: "Create two charts without overlapping data or each other"
        prompt: |
          1. Create a new empty Excel file at {{TEMP_DIR}}/llm-test-multi-chart-{{randomValue type='UUID'}}.xlsx and open it
          2. Put data in A1:C4 on Sheet1:
             Row 1: Category, Value1, Value2
             Row 2: Alpha, 10, 20
             Row 3: Beta, 15, 25
             Row 4: Gamma, 12, 18
          3. Create a pie chart from A1:B4 showing Value1 by Category
          4. Create a column chart from A1:A4 and C1:C4 showing Value2 by Category
          5. Position both charts so they: (a) don't overlap the data in A1:C4, (b) don't overlap each other
          6. List all charts and report each chart's topLeftCell to verify they're in different positions
          7. Save and close the file (so the result can be inspected)
        assertions:
          - type: no_hallucinated_tools
          - type: no_rate_limit_errors
          - type: no_clarification_questions
          - type: tool_called
            tool: excel_file
          - type: tool_called
            tool: excel_chart
          # Verify 2 charts exist
          - type: output_regex
            pattern: "(?i)(2 chart|two chart|chart 1.*chart 2|pie.*column)"
          # Verify data preserved
          - type: output_regex
            pattern: "(?i)(alpha|beta|gamma)"
          # Verify different positions reported
          - type: output_regex
            pattern: "(?i)(topLeftCell|position)"
