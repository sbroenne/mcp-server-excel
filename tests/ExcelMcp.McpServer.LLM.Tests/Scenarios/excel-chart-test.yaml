# =============================================================================
# Excel Chart Test - Positioning and Create-From-Table
# =============================================================================
#
# Consolidated test file covering:
#   1. Chart positioning to avoid data overlap
#   2. Create-from-table action for Excel Tables
#   3. Multiple chart scenarios
#
# Prerequisites:
#   - Windows 10/11 with Excel installed
#   - Excel MCP Server
#   - Environment: AZURE_OPENAI_ENDPOINT
#
# =============================================================================

criteria:
  success_rate: 1  # 100% required

ai_summary:
  enabled: true
  judge_provider: azure-openai-judge

providers:
  - name: azure-openai-gpt52-chat
    type: AZURE
    auth_type: entra_id
    model: gpt-5.1-chat
    baseUrl: "{{AZURE_OPENAI_ENDPOINT}}"
    version: 2025-01-01-preview
    rate_limits:
      requests_per_minute: 60
      tokens_per_minute: 150000
    retry:
      retry_on_429: true
      max_retries: 5
  - name: azure-openai-judge
    type: AZURE
    auth_type: entra_id
    model: gpt-4.1
    baseUrl: "{{AZURE_OPENAI_ENDPOINT}}"
    version: 2025-01-01-preview
    rate_limits:
      requests_per_minute: 60
      tokens_per_minute: 150000
    retry:
      retry_on_429: true
      max_retries: 5

servers:
  - name: excel-mcp
    type: stdio
    command: "{{SERVER_COMMAND}}"
    server_delay: 10s

agents:
  - name: gpt52-chat-agent
    servers:
      - name: excel-mcp
        allowed_tools:
          - excel_file
          - excel_range
          - excel_table
          - excel_chart
    provider: azure-openai-gpt52-chat
    skill:
      path: "{{SKILL_PATH_MCP}}"
      file_access: true
    clarification_detection:
      enabled: true
      judge_provider: azure-openai-judge

settings:
  verbose: true
  max_iterations: 15


sessions:
  # ==========================================================================
  # Session 1: Chart From Table - Basic Column Chart
  # ==========================================================================
  - name: "Chart From Table"
    tests:
      - name: "Create column chart from Excel Table"
        prompt: |
          Create a sales analysis chart:

          1. Create a new Excel file at {{TEMP_DIR}}/chart-from-table-{{randomValue type='UUID'}}.xlsx
          2. Enter this sales data in A1:C5:
             Product, Q1 Sales, Q2 Sales
             Laptop, 45000, 52000
             Phone, 38000, 41000
             Tablet, 22000, 28000
             Monitor, 15000, 18000
          3. Convert the data to a table called "SalesData"
          4. Create a column chart from the table using create-from-table
          5. Position it below the data (targetRange='A8:F20')
          6. Save and close
        assertions:
          - type: no_hallucinated_tools
          - type: no_clarification_questions
          - type: tool_called
            tool: excel_table
          - type: tool_called
            tool: excel_chart
          - type: output_regex
            pattern: "(?i)(salesdata|chart|created)"

  # ==========================================================================
  # Session 2: Chart Positioning - Below Data
  # ==========================================================================
  - name: "Chart Position Below Data"
    tests:
      - name: "Position chart below data table"
        prompt: |
          I need a chart that doesn't overlap my data:

          1. Create a new Excel file at {{TEMP_DIR}}/chart-position-{{randomValue type='UUID'}}.xlsx
          2. Put this budget data in A1:C6:
             Month, Revenue, Expenses
             January, 50000, 35000
             February, 55000, 38000
             March, 48000, 32000
             April, 62000, 41000
             May, 58000, 39000
          3. Create a line chart from the data
          4. Make sure the chart is positioned BELOW row 6 so it doesn't cover the data
          5. Read chart info and confirm the topLeftCell is row 7 or later
          6. Save and close
        assertions:
          - type: no_hallucinated_tools
          - type: no_clarification_questions
          - type: tool_called
            tool: excel_chart
          - type: output_regex
            pattern: "(?i)(chart|position|row [7-9]|\\$[A-Z]+\\$[7-9])"

  # ==========================================================================
  # Session 3: Multiple Charts - Different Types
  # ==========================================================================
  - name: "Multiple Chart Types"
    tests:
      - name: "Create pie and bar charts from same table"
        prompt: |
          Create a dashboard with multiple chart types:

          1. Create a new Excel file at {{TEMP_DIR}}/multi-chart-{{randomValue type='UUID'}}.xlsx
          2. Enter market data in A1:C5:
             Company, Revenue, Market Share
             Alpha, 500000, 35
             Beta, 400000, 28
             Gamma, 300000, 22
             Delta, 200000, 15
          3. Convert to a table called "MarketData"
          4. Create a PIE chart showing Market Share, position at F2:K12
          5. Create a BAR chart showing Revenue, position at F14:K24
          6. List charts and confirm both exist without overlapping
          7. Save and close
        assertions:
          - type: no_hallucinated_tools
          - type: no_clarification_questions
          - type: tool_called
            tool: excel_table
          - type: tool_called
            tool: excel_chart
          - type: output_regex
            pattern: "(?i)(pie|bar|2 chart|two chart)"

  # ==========================================================================
  # Session 4: targetRange Positioning
  # ==========================================================================
  - name: "targetRange Direct Positioning"
    tests:
      - name: "Use targetRange for exact chart placement"
        prompt: |
          Create a chart with precise cell-based positioning:

          1. Create a new Excel file at {{TEMP_DIR}}/chart-targetrange-{{randomValue type='UUID'}}.xlsx
          2. Enter quarterly data in A1:E5:
             Region, Q1, Q2, Q3, Q4
             North, 1000, 1200, 1100, 1400
             South, 800, 900, 950, 1000
             East, 1500, 1600, 1450, 1700
             West, 600, 700, 650, 800
          3. Create a bar chart using targetRange='G2:L15' for positioning
          4. Verify the chart's topLeftCell is at or near G2
          5. Save and close
        assertions:
          - type: no_hallucinated_tools
          - type: no_clarification_questions
          - type: tool_called
            tool: excel_chart
          - type: output_regex
            pattern: "(?i)(\\$G\\$2|G2|chart|created)"
