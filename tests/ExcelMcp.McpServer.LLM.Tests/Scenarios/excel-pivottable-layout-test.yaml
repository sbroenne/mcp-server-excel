# =============================================================================
# PivotTable Layout on Create Test
# =============================================================================
#
# Tests: Issue #366 - layoutStyle parameter on PivotTable create operations
#
# Verifies that LLMs can:
#   1. Create PivotTables with Tabular layout in a single operation
#   2. Create PivotTables with Compact layout (default)
#   3. Create PivotTables with Outline layout
#   4. Understand when to use each layout style
#
# Layout values:
#   0 = Compact (default - row fields in single column with indentation)
#   1 = Tabular (each row field in separate column - best for export/analysis)
#   2 = Outline (hierarchical with expand/collapse)
#
# Prerequisites:
#   - Windows 10/11 with Excel installed
#   - Excel MCP Server
#   - Environment: AZURE_OPENAI_ENDPOINT
#
# =============================================================================

criteria:
  success_rate: 1  # 100% required

ai_summary:
  enabled: true
  judge_provider: azure-openai-judge

providers:
  - name: azure-openai-gpt41
    type: AZURE
    auth_type: entra_id
    model: gpt-4.1
    baseUrl: "{{AZURE_OPENAI_ENDPOINT}}"
    version: 2025-01-01-preview
    retry:
      retry_on_429: true
      max_retries: 5
  - name: azure-openai-gpt52
    type: AZURE
    auth_type: entra_id
    model: gpt-5.2-chat
    baseUrl: "{{AZURE_OPENAI_ENDPOINT}}"
    version: 2025-01-01-preview
    retry:
      retry_on_429: true
      max_retries: 5
  - name: azure-openai-judge
    type: AZURE
    auth_type: entra_id
    model: gpt-5.2-chat
    baseUrl: "{{AZURE_OPENAI_ENDPOINT}}"
    version: 2025-01-01-preview

servers:
  - name: excel-mcp
    type: stdio
    command: "{{SERVER_COMMAND}}"
    server_delay: 30s

agents:
  - name: gpt41-agent
    servers:
      - name: excel-mcp
    provider: azure-openai-gpt41
    # Agent Skills: Load excel-mcp skill for server-specific guidance
    skill:
      path: "{{SKILL_PATH_MCP}}"
      file_access: true
    system_prompt: |
      You are {{AGENT_NAME}}, an Excel automation agent using {{PROVIDER_NAME}}.

      RULES:
      - Execute tasks immediately without asking for confirmation
      - Never ask clarifying questions - make reasonable assumptions and proceed
      - Never show Excel to the user - keep it hidden
      - Format Excel files professionally (proper column widths, headers, number formats, cell styles)
      - Always format data ranges as Excel Tables (not plain ranges)
      - Report results after completion
    clarification_detection:
      enabled: true
      judge_provider: azure-openai-judge
  - name: gpt52-agent
    servers:
      - name: excel-mcp
    provider: azure-openai-gpt52
    # Agent Skills: Load excel-mcp skill for server-specific guidance
    skill:
      path: "{{SKILL_PATH_MCP}}"
      file_access: true
    system_prompt: |
      You are {{AGENT_NAME}}, an Excel automation agent using {{PROVIDER_NAME}}.

      RULES:
      - Execute tasks immediately without asking for confirmation
      - Never ask clarifying questions - make reasonable assumptions and proceed
      - Never show Excel to the user - keep it hidden
      - Format Excel files professionally (proper column widths, headers, number formats, cell styles)
      - Always format data ranges as Excel Tables (not plain ranges)
      - Report results after completion
    clarification_detection:
      enabled: true
      judge_provider: azure-openai-judge

settings:
  verbose: true
  max_iterations: 15


sessions:
  # ==========================================================================
  # Test 1: Tabular Layout - Best for export and analysis
  # ==========================================================================
  - name: "Tabular Layout for Export"
    tests:
      - name: "Create PivotTable with Tabular layout"
        prompt: |
          I need to create a PivotTable that I can easily copy-paste into a database or CSV export tool. Each field should be in its own column so the data is flat and easy to work with in other applications.

          Create a new Excel file at {{TEST_RESULTS_PATH}}/pivottable-tabular-{{randomValue type='UUID'}}.xlsx

          Enter this sales data starting at A1:
          Region, Product, Quarter, Sales
          North, Laptops, Q1, 45000
          North, Laptops, Q2, 52000
          North, Phones, Q1, 28000
          North, Phones, Q2, 31000
          South, Laptops, Q1, 38000
          South, Laptops, Q2, 48000
          South, Phones, Q1, 24000
          South, Phones, Q2, 29000

          Convert it to a table called "SalesData".

          Then create a PivotTable on a new sheet called "Analysis" at cell A3 named "SalesPivot" with the appropriate layout for flat data export.

          Add Region and Product as row fields, and Sales as a value field.
        assertions:
          - type: no_hallucinated_tools
          - type: no_clarification_questions
          - type: tool_called
            tool: excel_pivottable
          - type: tool_param_equals
            tool: excel_pivottable
            param: layoutStyle
            value: 1
          - type: output_regex
            pattern: "(?i)(pivot|tabular|layout|created|success)"

      - name: "Verify and close"
        prompt: |
          Confirm the PivotTable was created with Tabular layout. Save and close the file.
        assertions:
          - type: no_hallucinated_tools
          - type: no_clarification_questions


  # ==========================================================================
  # Test 2: Compact Layout - Default hierarchical view
  # ==========================================================================
  - name: "Compact Layout Default"
    tests:
      - name: "Create PivotTable with Compact layout"
        prompt: |
          I want a PivotTable that saves horizontal space. Show all the row labels in a single column with indentation to indicate hierarchy - the default compact view that Excel normally uses.

          Create a new Excel file at {{TEST_RESULTS_PATH}}/pivottable-compact-{{randomValue type='UUID'}}.xlsx

          Enter this data starting at A1:
          Department, Team, Employee, Hours
          Engineering, Backend, Alice, 160
          Engineering, Backend, Bob, 152
          Engineering, Frontend, Carol, 168
          Engineering, Frontend, Dave, 144
          Sales, Direct, Eve, 176
          Sales, Direct, Frank, 160
          Sales, Partners, Grace, 148

          Convert it to a table called "TimeTracking".

          Create a PivotTable on a new sheet at A3 named "HoursSummary" with the standard compact indented layout.

          Add Department and Team as row fields, and Hours as a value field.
        assertions:
          - type: no_hallucinated_tools
          - type: no_clarification_questions
          - type: tool_called
            tool: excel_pivottable
          - type: tool_param_equals
            tool: excel_pivottable
            param: layoutStyle
            value: 0
          - type: output_regex
            pattern: "(?i)(pivot|compact|layout|created|success)"

      - name: "Verify and close"
        prompt: |
          Confirm the PivotTable was created. Save and close the file.
        assertions:
          - type: no_hallucinated_tools
          - type: no_clarification_questions


  # ==========================================================================
  # Test 3: Outline Layout - Expandable hierarchy
  # ==========================================================================
  - name: "Outline Layout Hierarchical"
    tests:
      - name: "Create PivotTable with Outline layout"
        prompt: |
          I need a PivotTable where I can expand and collapse groups to drill down through the geographic hierarchy. Each level should have its own column with +/- buttons to show or hide the details underneath.

          Create a new Excel file at {{TEST_RESULTS_PATH}}/pivottable-outline-{{randomValue type='UUID'}}.xlsx

          Enter this data starting at A1:
          Country, State, City, Revenue
          USA, California, Los Angeles, 500000
          USA, California, San Francisco, 450000
          USA, Texas, Houston, 380000
          USA, Texas, Dallas, 320000
          Canada, Ontario, Toronto, 420000
          Canada, Ontario, Ottawa, 180000
          Canada, BC, Vancouver, 350000

          Convert it to a table called "GeoRevenue".

          Create a PivotTable on a new sheet at A3 named "RegionalAnalysis" with a layout that supports expanding and collapsing hierarchy levels.

          Add Country, State, and City as row fields, and Revenue as a value field.
        assertions:
          - type: no_hallucinated_tools
          - type: no_clarification_questions
          - type: tool_called
            tool: excel_pivottable
          - type: tool_param_equals
            tool: excel_pivottable
            param: layoutStyle
            value: 2
          - type: output_regex
            pattern: "(?i)(pivot|outline|layout|created|success)"

      - name: "Verify and close"
        prompt: |
          Confirm the PivotTable was created with Outline layout. Save and close the file.

          Summarize: What are the three layout styles and when should each be used?
        assertions:
          - type: no_hallucinated_tools
          - type: no_clarification_questions
          - type: output_regex
            pattern: "(?i)(compact|tabular|outline)"
